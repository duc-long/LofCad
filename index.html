<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lofcad</title>
    <link rel="icon" type="image/png" href="flash-cards.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/string-similarity@4.0.4/umd/string-similarity.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        html,
body {
       margin: 0;
    padding: 0;
}


.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.3); /* lớp tối mờ */
    z-index: -1;
}


        @media (max-width: 768px) {

            html,
            body {
                height: 100%;

            }

            .main-wrapper {
                height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
        }

        body {
            background-color: #f8f9fa;
            font-size: smaller;

        }

        .container {
            max-width: 1200px;
        }

        .fc-pic {
            width: 100%;
            height: auto;
            max-width: 200px;
            /* Điều chỉnh kích thước tối đa tùy theo thiết kế */
            margin: 10px auto;
            /* Căn giữa hình ảnh */
            display: block;
        }



        .fc-text {
            display: flex;
            align-items: center;
            font-size: 16px;
            /* Kích thước chữ */
            color: #333;
            /* Màu chữ */
        }

        .lofcad-text {
            color: #4255ff;
            /* Chữ LOFCAD màu xanh */
        }

        .plus-text {
            color: #fdb54a;
            /* Chữ PLUS màu cam */
            font-weight: bold;
            /* Làm chữ đậm */
        }

        /* ===== VARIABLES ===== */
        :root {
            --primary-color: #4a6fa5;
            --primary-color-light: #5d7bb0;
            --primary-color-dark: #3a5a8c;
            --accent-color: #0d5746;
            --text-color: #2d3748;
            --text-color-light: #4a5568;
            --background-color: #f9fafd;
            --card-shadow: 0 10px 25px rgba(74, 111, 165, 0.15);
            --card-border: 1px solid rgba(74, 111, 165, 0.1);
            --border-radius: 12px;
            --transition-speed: 0.6s;
        }

        /* ===== FLASHCARD CONTAINER ===== */
        .flashcard {
            width: 100%;
            height: 100vh;
            /* Use viewport height for full height */
            position: relative;
            overflow: hidden;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            margin: 0;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            border: var(--card-border);
            background-color: white;
        }

        /* ===== CARD SIDES (FRONT & BACK) ===== */
        .flashcard-front,
        .flashcard-back {
            cursor: pointer;
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            align-items: center;
            justify-content: center;
            padding: 40px;
            box-sizing: border-box;
            border-radius: var(--border-radius);
            transition: opacity var(--transition-speed) ease,
                transform var(--transition-speed) ease;
        }

        .flashcard-front {
            background: white;
            z-index: 2;
            border-bottom: 5px solid var(--primary-color);
        }

        .flashcard-back {
            background: white;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            z-index: 1;
            border-bottom: 5px solid var(--accent-color);
        }

        /* ===== CONTENT STYLING ===== */
        .flashcard-content {
            width: 100%;
            max-width: 900px;
            text-align: center;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .flashcard-front h2,
        .flashcard-back h2 {
            margin: 0 0 20px 0;
            color: var(--primary-color-dark);
            font-size: 2.2rem;
            font-weight: 600;
            letter-spacing: -0.5px;
            position: relative;
            display: inline-block;
        }

        .flashcard-front h2:after,
        .flashcard-back h2:after {
            content: '';
            position: absolute;
            width: 60%;
            height: 3px;
            bottom: -10px;
            left: 20%;
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .flashcard-front p,
        .flashcard-back p {
            line-height: 1.7;
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--text-color-light);
        }

        /* ===== IMPROVED SCROLLBAR ===== */
        .flashcard-front::-webkit-scrollbar,
        .flashcard-back::-webkit-scrollbar {
            width: 8px;
        }

        .flashcard-front::-webkit-scrollbar-track,
        .flashcard-back::-webkit-scrollbar-track {
            background: rgba(241, 241, 241, 0.6);
            border-radius: 10px;
            margin: 10px;
        }

        .flashcard-front::-webkit-scrollbar-thumb,
        .flashcard-back::-webkit-scrollbar-thumb {
            background: var(--primary-color-light);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .flashcard-front::-webkit-scrollbar-thumb:hover,
        .flashcard-back::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        /* ===== ELEGANT FLIP ANIMATION ===== */
        .flashcard.flipped .flashcard-front {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-25px);
        }

        .flashcard.flipped .flashcard-back {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* ===== ENHANCED IMAGES ===== */
        .flashcard-front img,
        .flashcard-back img {
            height: auto;
            max-height: 300px;
            width: auto;
            max-width: 100%;
            object-fit: contain;
            display: block;
            margin: 20px auto 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 4px solid white;
        }

        .flashcard-front img:hover,
        .flashcard-back img:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }



        /* ===== STUDY MODE ===== */
        .study-mode {

            min-height: 100vh;
            padding: 30px;
            color: white;

        }

        .study-mode .flashcard {
            border: none;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        }
#speedRange {
    cursor: pointer;
  accent-color: #656fe4;
}

.autoplayBut{
    border-color: black;
}

        .prevbut,
        .nextbut {
            background-color: rgba(255, 255, 255, 0);
            color: black;
            padding: 5% 30%;
            border-radius: 30px;
        }


        .prevbut:hover,
        .nextbut:hover {
            background-color: rgba(105, 105, 105, 0.174) !important;
            color: black;
        }

        .fullscreen-mode {
            background-color: #ffffff;
            color: #ffffff;
        }

        .dark-theme .fullscreen-mode {
            background-color: #121212;
            /* hoặc #1e1e1e - nền tối */
            color: #ffffff;
            /* chữ trắng */
        }

        /* ===== FULLSCREEN MODE ===== */
        .fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            background: linear-gradient(135deg, #2b3242, #3a4151);
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen .flashcard {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0;
        }

        /* ===== IMAGE PREVIEW ===== */
        #imagePreview {
            max-width: 250px;
            max-height: 250px;
            margin: 20px auto;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border: 5px solid white;
            transition: transform 0.3s ease;
        }

        #imagePreview:hover {
            transform: scale(1.02);
        }

        /* ===== BEAUTIFUL BUTTONS ===== */
        .flashcard-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 25px 0 15px;
            width: 100%;
        }

        .flashcard-button {
            background: linear-gradient(to right, var(--primary-color), var(--primary-color-dark));
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(74, 111, 165, 0.2);
            position: relative;
            overflow: hidden;
        }

        .flashcard-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: all 0.6s ease;
        }

        .flashcard-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(74, 111, 165, 0.3);
        }

        .flashcard-button:hover:before {
            left: 100%;
        }

        .flashcard-button.secondary {
            background: linear-gradient(to right, #f5f8ff, #edf2fd);
            color: var(--primary-color-dark);
            border: 1px solid var(--primary-color-light);
            box-shadow: 0 4px 12px rgba(74, 111, 165, 0.1);
        }

        /* ===== DECORATION ELEMENTS ===== */
        .corner-decoration {
            position: absolute;
            width: 150px;
            height: 150px;
            opacity: 0.05;
            z-index: 0;
        }

        .corner-decoration.top-left {
            top: 0;
            left: 0;
            background: radial-gradient(circle at top left, var(--primary-color), transparent 70%);
        }

        .corner-decoration.bottom-right {
            bottom: 0;
            right: 0;
            background: radial-gradient(circle at bottom right, var(--accent-color), transparent 70%);
        }

        .dark-theme {
            --primary-color: #5c9ded;
            --primary-color-light: #8bbcf5;
            --primary-color-dark: #3a7dd3;

            --accent-color: #f57c00;
            --accent-color-light: #ffb74d;

            --text-color-light: white;
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            --card-border: 1px solid #333;

            --border-radius: 16px;
            --transition-speed: 0.4s;
        }

        .dark-theme .flashcard {
            background-color: #1e1e1e;
            color: var(--text-color-light);
            box-shadow: var(--card-shadow);
            border: var(--card-border);
        }

        .dark-theme .flashcard-front,
        .dark-theme .flashcard-back {
            background: linear-gradient(to bottom, #2a2a2a, #1f1f1f);
        }

        .dark-theme .flashcard-content {
            background-color: rgba(40, 40, 40, 0.85);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        .dark-theme .flashcard-front h2,
        .dark-theme .flashcard-back h2 {
            color: var(--primary-color-light);
        }

        .dark-theme .flashcard-front p,
        .dark-theme .flashcard-back p {
            color: var(--text-color-light);
        }

        .dark-theme .flashcard-front img,
        .dark-theme .flashcard-back img {
            border: 4px solid #333;
        }

        .dark-theme .flashcard-button.secondary {
            background: linear-gradient(to right, #2f2f2f, #1f1f1f);
            color: var(--primary-color-light);
            border: 1px solid #444;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {

            .flashcard-front,
            .flashcard-back {
                padding: 25px 15px;
            }

            .flashcard-content {
                padding: 15px;
            }

            .flashcard-front h2,
            .flashcard-back h2 {
                font-size: 1.8rem;
            }

            .flashcard-front p,
            .flashcard-back p {
                font-size: 1.1rem;
            }

            .flashcard-button {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }

        /* ===== PROGRESS INDICATOR ===== */
        .progress-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 500px;
            height: 6px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
            z-index: 10;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            width: 0%;
            transition: width 0.5s ease;
        }

        /* ===== CARD NUMBER ===== */
        .card-number {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: rgba(0, 0, 0, 0.3);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* ===== ADDITIONAL ANIMATIONS ===== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .flashcard-content {
            animation: fadeIn 0.5s ease-out;
        }

        .card-text {
            white-space: pre-wrap;
            overflow-wrap: break-word;
            /* Chữ sẽ tự ngắt dòng khi cần */
            display: inline-block;
            /* Chuyển sang chế độ inline-block cho vai trò generic */
            line-height: 1.5;
            /* Dãn dòng */
            margin-bottom: 1rem;
            /* Khoảng cách dưới */
            word-break: break-word;
            /* Đảm bảo từ dài được ngắt dòng */
        }

        #currentDeckName {
            background: linear-gradient(90deg, #00B4DB, #0083B0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            /* Optional for Firefox */
            background-clip: text;
            color: transparent;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        .card-body {
            -ms-flex: 1 1 auto;
            flex: 1 1 auto;
            min-height: 1px;
            padding: 1.25rem;

        }



        .deck-card {
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .deck-card:hover {
            transform: translateY(-5px);
        }

        /* Tabs container - cố định trên cùng, full width */
        .nav-tabs {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 8px 16px;
            display: flex;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* Đệm nội dung phía dưới để tránh bị che mất */
        body {
            padding-top: 60px;
            /* điều chỉnh nếu nav-tabs cao hơn/thấp hơn */
        }

        /* Link chung cho các tab */
        .nav-item .nav-link {
            font-family: "Segoe UI", Arial, sans-serif;
            color: #333 !important;
            background-color: transparent;
            padding: 10px 25px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: none;
        }

        /* Tab đang active */
        .nav-item .nav-link.active {
            color: #fff !important;
            color: #4255ff !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        /* Hover tab */
        .nav-item .nav-link:hover {

            color: #5564ecf3 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }



        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: left;
            font-family: inherit;
        }

        .control-panel {
            background: rgb(255, 255, 255);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .progress-info {
            background: linear-gradient(90deg, #00B4DB, #0083B0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            /* Optional for Firefox */
            background-clip: text;
            color: transparent;
            font-size: 1.2em;
            margin: 15px 0;
        }

        /* Modal styles for editing deck */
        .modal-dialog {
            max-width: 800px;
            /* Increased width for better flashcard management */
        }

        .result-correct,
        .result-incorrect {
            margin-top: 15px;
        }

        /* Styles for Flashcard Management within Deck Edit Modal */
        .flashcard-item {
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            position: relative;
        }

        h4#currentDeckName.text-center.mb-4 {
            color: white;
            display: block;
            justify-content: center;
            font-style: italic;
            font-size: smaller;
            height: min-content;
            width: min-content;
        }

        .flashcard-actions {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .flashcard-actions button {
            margin-left: 5px;
        }

        #optionsContainer .quiz-option {
            text-align: left !important;
            justify-content: flex-start !important;
        }

        /* Enhanced styles for quiz feedback */
        .quiz-option.correct {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            position: relative;
        }

        .quiz-option.correct::after {
            content: '\2714';
            /* Checkmark */
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        .quiz-option.incorrect {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
            animation: shake 0.5s;
            position: relative;
        }

        .quiz-option.incorrect::after {
            content: '\2716';
            /* Cross mark */
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        .quiz-mode {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .quiz-mode {
            background-color: #1c242b;
        }

        .quiz-mode h4 {
            color: #3a7dd3;
            margin-bottom: 20px;
        }

        .quiz-option {
            background-color: #f1f1f1;
            border: none;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 15px;
            font-size: 1.1em;
            transition: background-color 0.3s, transform 0.3s;
        }

        .quiz-option:hover {
            background-color: #e2e6ea;
            transform: translateX(5px);
        }

        .quiz-option.correct {
            background-color: #d4edda !important;
            border-color: #c3e6cb !important;
            color: #155724 !important;
        }

        .quiz-option.incorrect {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
            color: #721c24 !important;
            animation: shake 0.5s;
        }

        /* Thêm biểu tượng cho đáp án đúng/sai */
        .quiz-option.correct::after {
            content: '\2714';
            /* Checkmark */
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5em;
            color: #155724;
        }

        .styled-content {
            white-space: pre-wrap;
            /* Preserves spaces and line breaks */
            word-wrap: break-word;
            /* Prevents overflow by breaking long words */
            font-family: inherit;
            /* Matches the font of the surrounding content */
            padding: 10px;
            /* Optional: Adds padding around the content */
            border: 1px solid #ddd;
            /* Optional: Adds a border for distinction */
            background-color: #f9f9f9;
            /* Optional: Light background for better readability */
            border-radius: 5px;
            /* Optional: Rounded corners */
        }

        .quiz-option.incorrect::after {
            content: '\2716';
            /* Cross mark */
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5em;
            color: #721c24;
        }

        /* Cải thiện giao diện câu hỏi */
        .quiz-question {
            font-size: 1.3em;
            color: #343a40;
            margin-bottom: 20px;
        }

        /* Cải thiện giao diện kết quả */
        .result-correct,
        .result-incorrect {
            background-color: #ffffff;
            border-left: 5px solid #28a745;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .result-incorrect {
            border-left-color: #dc3545;
        }

        /* Responsive hình ảnh trong câu hỏi */
        .quiz-image {
            max-width: 100%;
            height: auto;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .btn-primary,
        .btn-success,
        .btn-danger,
        .btn-warning {
            border-radius: 18px;
        }

        /* Thêm màu sắc cho các nút trong kiểm tra */
        .btn-primary {
            background-color: #037a89;
            border-color: #048697;
        }

        .btn-primary:hover {
            background-color: #037a89;
            color: black;
            border-color: #0062cc;
        }

        .btn-success {
            background-color: #1d8735;
            border-color: #28a745;
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .btn-danger:hover {
            background-color: #c82333;
            color: black;
            border-color: #bd2130;
        }

        .btn-warning {
            background-color: #593E67;
            color: white;
            border-color: #593E67;
        }

        .btn-warning:hover {
            background-color: #83495F;
            color: black;
            border-color: #83495F;
        }

        /* Thêm khoảng cách và căn giữa cho các nút */
        .control-panel .btn {
            margin-right: 10px;
        }

        /* === QUIZ CONTAINER === */
        #quizContent {
            padding: 20px;
            border-radius: 16px;
            line-height: 1.8;
            font-size: 1.2rem;
            color: #343a40;
            margin-top: 25px;
            transition: all 0.3s ease;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        #quizContent .card {
            word-break: break-word;
            border: none;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
        }

        /* === QUIZ TITLE AND HEADER === */
        #quizContent .card-header {
            background: linear-gradient(135deg, #4A90E2, #5271ff);
            padding: 18px;
            color: white;
            font-weight: 600;
            letter-spacing: 0.5px;
            border-bottom: none;
        }

        h5.card-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #2c3e50;
            position: relative;
            padding-bottom: 10px;
        }

        h5.card-title:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, #4A90E2, #5271ff);
            border-radius: 3px;
        }

        /* === QUIZ QUESTIONS === */
        #quizContent .quiz-question {
            white-space: pre-wrap;
            font-size: 1.1rem;
            margin-bottom: 25px;
            text-align: left;
            word-spacing: 0.12rem;
            padding: 5px 0;
            line-height: 1.9;
            color: #2c3e50;
            font-weight: 500;
        }

        /* === QUIZ IMAGES === */
        #quizContent img.quiz-image {
            max-width: 100%;
            height: auto;
            margin: 15px 0 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #quizContent img.quiz-image:hover {
            transform: scale(1.02);
        }

        /* === QUIZ OPTIONS === */
        #quizContent .quiz-option {
            background: linear-gradient(to right, #f8f9fa, #f1f3f5);
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 15px;
            font-size: 0.95rem;
            color: #495057;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        #quizContent .quiz-option:before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #5271ff;
            margin-right: 12px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        #quizContent .quiz-option:hover {
            background: linear-gradient(to right, #e9ecef, #dee2e6);
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        /* === CORRECT AND INCORRECT STATES === */
        #quizContent .quiz-option.correct {
            background: linear-gradient(to right, #c8e6c9, #a5d6a7);
            border-color: #81c784;
            color: #2e7d32;
            font-weight: 500;
            box-shadow: 0 4px 8px rgba(46, 125, 50, 0.15);
        }

        #quizContent .quiz-option.correct:before {
            background-color: #2e7d32;
            border-color: #2e7d32;
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }

        #quizContent .quiz-option.incorrect {
            background: linear-gradient(to right, #ffcdd2, #ef9a9a);
            border-color: #e57373;
            color: #c62828;
            font-weight: 500;
            box-shadow: 0 4px 8px rgba(198, 40, 40, 0.15);
        }

        #quizContent .quiz-option.incorrect:before {
            background-color: #c62828;
            border-color: #c62828;
            box-shadow: 0 0 0 2px rgba(198, 40, 40, 0.2);
        }

        /* === RESULT FEEDBACK === */
        .result-correct,
        .result-incorrect {
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: 500;
            position: relative;
            padding-left: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }

        .result-correct {
            background-color: #e8f5e9;
            border-left: 5px solid #81c784;
            color: #2e7d32;
        }

        .result-incorrect {
            background-color: #ffebee;
            border-left: 5px solid #ef9a9a;
            color: #c62828;
        }

        .dark-theme #quizContent {
            background: linear-gradient(145deg, #2a2d3a, #1f212b);
            color: #e4e6eb;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        }

        .dark-theme #quizContent .card {
            background-color: #2e3140;
            backdrop-filter: blur(5px);
        }

        .dark-theme #quizContent .card-header {
            background: linear-gradient(135deg, #5568fe, #7289da);
            color: #ffffff;
        }

        .dark-theme h5.card-title {
            color: #ffffff;
        }

        .dark-theme h5.card-title:after {
            background: linear-gradient(90deg, #7289da, #8aaaff);
        }

        .dark-theme #quizContent .quiz-question {
            color: #e0e0e0;
        }

        .dark-theme #quizContent .quiz-option {
            background: linear-gradient(to right, #3b3f52, #484c60);
            border: 1px solid #5a5f77;
            color: #d8dbe3;
        }

        .dark-theme #quizContent .quiz-option:before {
            border-color: #8aaaff;
        }

        .dark-theme #quizContent .quiz-option:hover {
            background: linear-gradient(to right, #44485f, #53576f);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
        }

        /* === CORRECT === */
        .dark-theme #quizContent .quiz-option.correct {
            background: linear-gradient(to right, #3b5e3b, #4a7d4a);
            border-color: #66bb6a;
            color: #ffffff !important;
        }

        .dark-theme #quizContent .quiz-option.correct:before {
            background-color: #81c784;
            border-color: #66bb6a;
        }

        /* === INCORRECT === */
        .dark-theme #quizContent .quiz-option.incorrect {
            background: linear-gradient(to right, #5c2b2b, #6e3535);
            border-color: #ef5350;
            color: #ffffff !important;
        }

        .dark-theme #quizContent .quiz-option.incorrect:before {
            background-color: #ef9a9a;
            border-color: #ef5350;
        }

        /* === FEEDBACK MESSAGES === */
        .dark-theme .result-correct {
            background-color: #2e7d32;
            border-left: 5px solid #66bb6a;
            color: #ffffff !important;
        }

        .dark-theme .result-incorrect {
            background-color: #b71c1c;
            border-left: 5px solid #ef5350;
            color: #ffffff !important;
        }

        /* === ANIMATION EFFECTS === */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #quizContent .card {
            animation: fadeIn 0.5s ease forwards;
        }

        #quizContent .quiz-option {
            animation: fadeIn 0.3s ease forwards;
            animation-delay: calc(var(--i) * 0.1s);
            opacity: 0;
        }

        /* === RESPONSIVE ADJUSTMENTS === */
        @media (max-width: 768px) {
            #quizContent {
                padding: 15px;
                font-size: 1rem;
            }

            #quizContent .quiz-question {
                font-size: 1rem;
            }

            #quizContent .quiz-option {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 576px) {
            #quizContent {
                padding: 10px;
            }

            h5.card-title {
                font-size: 1.1rem;
            }

            #quizContent .quiz-option:before {
                width: 16px;
                height: 16px;
                margin-right: 10px;
            }
        }

        .dark-theme {
            background-color: #252525;
            color: #e0e0e0;
        }

        .dark-theme .form-control {
            background-color: #5c5c5c;
            border-color: #5c5c5c;
            color: #f9f9f9;
        }

        .dark-theme textarea.form-control {
            background-color: #5c5c5c;
            border-color: #5c5c5c;
            color: #f9f9f9;
        }

        /* Áp dụng cho chế độ dark theme */


        /* Nút điều hướng (tab bình thường) */
        .dark-theme .nav-tabs {
            background-color: #1e1e1e;
            border-bottom: 1px solid #444;
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
        }

        .dark-theme .nav-item .nav-link {
            font-family: "Segoe UI", Arial, sans-serif;
            color: rgb(143, 155, 151) !important;
            background-color: transparent;
            padding: 10px 18px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: none;
        }

        .dark-theme .nav-item .nav-link.active {
            color: #6CBE77 !important;
            background-color: rgba(213, 229, 223, 0.137) !important;
            box-shadow: 0 2px 6px rgba(255, 255, 255, 0.05);
            font-weight: 600;
        }

        .dark-theme .nav-item .nav-link:hover {
            color: #8ad394 !important;
            background-color: #444 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.05);
        }

        .dark-theme .card {
            background-color: #302f2f;
            border-color: #333333;
        }

        .dark-theme .btn-primary {
            background-color: #198998;
            border-color: #198998;
        }

        .dark-theme .btn-primary:hover {
            background-color: #198998;
            color: black;
            border-color: #6034fe;
        }

        .dark-theme .btn-secondary {
            background-color: #02655b;
            border-color: #02655b;
        }

        .dark-theme .btn-secondary:hover {
            background-color: #02655b;
            border-color: #02655b;
        }

        .dark-theme .btn-warning {
            background-color: #684b77;
            border-color: #684b77;
        }

        .dark-theme .btn-warning:hover {
            background-color: #684b77;
            border-color: #684b77;
        }

        .dark-theme .btn-danger {
            background-color: #f04735;
            border-color: #f04735;
        }

        .dark-theme .btn-danger:hover {
            background-color: #dc2c19;
            color: black;
            border-color: #e32f1b;
        }

        .dark-theme .flashcard-front,
        .dark-theme .flashcard-back {
            background-color: #2c2c2c;
            color: #e0e0e0;
        }

        .dark-theme .card-text {
            color: #e0dcdc;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            display: inline-block;
            line-height: 1.5;
            word-break: break-word;


        }

        .dark-theme h5.card-title {
            color: #ffffff;
        }

        .dark-theme .control-panel {
            background: rgba(0, 0, 0, 0.5);
        }

        .dark-theme .nav-tabs .nav-link.active {
            border-color: #333333 #333333 #121212;
        }

        :root {
            /* Light Theme */
            --light-bg: #f5f5f5;
            --light-text: #1a1a1a;

            /* Dark Theme */
            --dark-bg: #121212;
            /* Tối hơn một chút, ít chói mắt */
            --dark-text: #e0e0e0;
            /* Màu trắng ngả xám cho dễ đọc hơn */

            /* Toggle Switch (chỉnh kích thước nhỏ gọn) */
            --toggle-width: 64px;
            --toggle-height: 32px;
            --thumb-size: 24px;
        }

        .theme-toggle {
            position: relative;
            width: var(--toggle-width);
            height: var(--toggle-height);
            border-radius: var(--toggle-height);
            /* Make it fully rounded */
            border: none;
            cursor: pointer;
            background-color: #fef3c7;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* Align thumb to the start by default */
            padding: 4px;
            overflow: hidden;
            /* Ensure thumb stays within the button */
        }

        body.dark-theme .theme-toggle {
            justify-content: flex-end;
            /* Move thumb to the end in dark mode */
            background-color: #111827;
        }

        .toggle-thumb {
            position: relative;
            /* Use relative for alignment */
            width: var(--thumb-size);
            height: var(--thumb-size);
            border-radius: 50%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.4s ease;
            background-color: #fbbf24;
            transition: background-color 0.4s ease, color 0.4s ease;
        }

        body.dark-theme .toggle-thumb {
            background-color: #60a5fa;
        }

        .sun-icon,
        .moon-icon {
            position: absolute;
            width: 10px;
            /* Adjusted to match smaller size */
            height: 10px;
            /* Adjusted to match smaller size */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            /* Ensure icons don't interfere with clicks */
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .moon-icon {
            opacity: 0;
            /* Hide moon icon by default */
            color: white;
        }

        .sun-icon {
            opacity: 1;
            /* Show sun icon by default */
            color: #78350f;
        }

        body.dark-theme .sun-icon {
            opacity: 0;
            /* Hide sun icon in dark mode */
        }

        body.dark-theme .moon-icon {
            opacity: 1;
            /* Show moon icon in dark mode */
        }

        /* Gọn và nhỏ nút chuyển theme */
        #themeToggle.theme-toggle,
        #toggleEffect.btn.btn-success {
            margin: 2px 0 2px 10px;
            padding: 2px 8px;
            border-radius: 18px;
        }

        /* Ẩn phần tử */
        .hidden,
        .d-none {
            display: none !important;
        }

        /* Nút Quiz nhỏ gọn */
        #toggleQuiz.btn.btn-info {
            height: 16px;
            padding: 0 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: auto;
            border: 1px solid #138496;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.3s ease;
            font-size: 12px;
        }


        #effectContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* Để người dùng không bị cản trở khi nhấn vào các phần khác */
            overflow: hidden;
            z-index: 9999;
        }

        .leaf,
        .flower {
            position: absolute;
            top: -50px;
            font-size: 18px;
            animation: fall linear infinite;
            opacity: 0.8;
        }

        @keyframes fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
                /* Hiển thị hoàn toàn */
            }

            90% {
                opacity: 1;
                /* Phần tử vẫn còn hiển thị khi gần chạm đáy */
            }

            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
                /* Phần tử mờ dần khi rơi khỏi màn hình */
            }
        }

        /* Mobile Styles: Dưới 576px */
        @media (max-width: 575.98px) {
            body {
                font-size: 14px;
            }


            .nav-tabs {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                background-color: #f8f9fa;
                border-bottom: 1px solid #dee2e6;
                padding: 8px 16px;
                display: flex;
                justify-content: center;
                gap: 6px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }


            .fc-pic {
                width: 24px;
                height: 24px;
                margin-right: 8px;
                margin-bottom: 8px;
            }

            .fc-text {
                font-size: 14px;
            }

            .flashcard {
                height: 535px;
            }

            .responSamsung select,
            .responSamsung button:not(#fullscreenBtn) {
                display: none !important;
            }

            /* Chiếm toàn bộ chiều ngang và đẩy nút sang phải */
            .responSamsung {
                width: 100%;
                margin-top: -20px;
                justify-content: flex-end !important;
            }

            #fullscreenBtn {
                display: inline-flex !important;
                align-items: center;
                justify-content: center;
                margin-right: -5px;
                /* tùy chọn */
                margin-top: -5px;
            }

            #quizContent {
                height: 680px;
            }

            #optionsContainer .btn {
                height: auto;
                /* Cho phép nút giãn chiều cao theo nội dung */
                min-height: 80px;
                margin-top: 8%;
                font-size: 22px;
                /* Cỡ chữ bạn yêu cầu */
                white-space: normal;
                /* Cho phép xuống dòng nếu chữ dài */
                word-wrap: break-word;
                text-align: left;
                padding: 12px 16px;
                line-height: 1.4;
            }

            #quizContent .question-text.question-big {
                font-size: 4rem !important;
            }

            #quizContent .question-text.question-small {
                font-size: 1.5rem !important;
            }



            button#toggleQuiz.btn.btn-info {
                height: 24px;
                padding: 4px 6px;
                font-size: 0.8rem;
            }


            button#toggleEffect.btn.btn-success {
                padding: 2px 6px;
                border-radius: 14px;
            }

            /* Điều chỉnh hiệu ứng hoa/cỏ cho màn hình nhỏ */
            .leaf,
            .flower,
            .flowleaf {
                font-size: 16px;
            }
        }

        /* Tablet Styles: Từ 576px đến 768px */
        @media (min-width: 576px) and (max-width: 767.98px) {
            body {
                font-size: 15px;
            }



            .fc-pic {
                width: 28px;
                height: 28px;
                margin-right: 9px;
                margin-bottom: 9px;
            }

            .fc-text {
                font-size: 15px;
            }

            .flashcard {
                height: 350px;
            }

            .quiz-option {
                padding: 12px 16px;
                font-size: 1rem;
            }

            button#toggleQuiz.btn.btn-info {
                height: 28px;
                padding: 4px 8px;
                font-size: 0.85rem;
            }


            button#toggleEffect.btn.btn-success {
                padding: 3px 7px;
                border-radius: 16px;
            }

            /* Điều chỉnh hiệu ứng hoa/cỏ cho màn hình trung bình */
            .leaf,
            .flower,
            .flowleaf {
                font-size: 17px;
            }
        }

        /* Desktop Styles: Trên 768px */
        @media (min-width: 768px) {
            body {
                font-size: 16px;
            }

            .container {
                padding: 20px;
            }

            .fc-pic {
                width: 30px;
                height: 30px;
                margin: 0 10px 10px 2px;
                cursor: pointer;
            }

            .fc-text {
                cursor: pointer;
                margin-bottom: 10px;
            }

            .flashcard {
                height: 400px;
            }

            .quiz-option {
                padding: 15px 20px;
                font-size: 1.1rem;
            }

            button#toggleQuiz.btn.btn-info {
                height: 30px;
                padding: 5px 10px;
                font-size: 0.9rem;
            }

            button#toggleEffect.btn.btn-success {
                padding: 4px 8px;
                border-radius: 18px;
            }

            /* Điều chỉnh hiệu ứng hoa/cỏ cho màn hình lớn */
            .leaf,
            .flower,
            .flowleaf {
                font-size: 18px;
            }
        }

        @media (max-width: 575.98px) {
            button#toggleQuiz.btn.btn-info {
                height: 20px;
                padding: 2px 4px;
                font-size: 0.8rem;
            }
        }

        @media (min-width: 576px) and (max-width: 767.98px) {
            button#toggleQuiz.btn.btn-info {
                height: 22px;
                padding: 3px 5px;
                font-size: 0.85rem;
            }
        }

        /* ================= MOBILE STYLE for nav-tabs ================= */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
                /* Cho phép xuống dòng */
                justify-content: flex-start;
                padding: 2px 2px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                /* Firefox */
            }

            .nav-tabs::-webkit-scrollbar {
                display: none;
                /* Ẩn thanh cuộn trên mobile */
            }

            .nav-item .nav-link {
                font-size: 10px;
                padding: 2px 4px;
                white-space: nowrap;
                /* Giữ mỗi tab là một dòng */
                margin-bottom: 4px;
            }

            /* Tùy chọn thêm: bo tròn container nav-tabs */
            .nav-tabs {
                border-radius: 0 0 10px 10px;

            }

            .tab-pane button#toggleQuiz.btn.btn-info {
                margin-top: 5%;
            }
        }

        @media (max-width: 768px) {
            .dark-theme .nav-tabs {
                flex-wrap: wrap;
                justify-content: flex-start;
                padding: 8px 8px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                background-color: #1e1e1e;
                border-bottom: 1px solid #444;
                border-radius: 0 0 10px 10px;
            }

            .dark-theme .nav-tabs::-webkit-scrollbar {
                display: none;
            }

            .dark-theme .nav-item .nav-link {
                font-size: 14px;
                padding: 8px 12px;
                color: rgb(180, 190, 185) !important;
                white-space: nowrap;
                margin-bottom: 4px;
            }

            .dark-theme .nav-item .nav-link.active {
                color: #6CBE77 !important;
                background-color: rgba(213, 229, 223, 0.12) !important;
            }

            .dark-theme .nav-item .nav-link:hover {
                color: #8ad394 !important;
                background-color: #444 !important;
            }
        }



        /* Thêm vào phần <style> trong <head> */
        .achievement-card {
            width: 18rem;
            margin: 1rem;
        }

        .achievement-card .card-body {
            text-align: center;
        }

        .achievement-earned {
            border: 2px solid gold;
        }

        .achievement-unearned {
            opacity: 0.6;
        }

        .dark-theme .badge-container {
            background-color: #1e1e2f;
            color: #ffffff;
        }

        .dark-theme .badge-title {
            color: #ffffff;
        }

        .dark-theme .badge-item {
            background-color: #292942;
            color: #ffffff;
        }

        .dark-theme .badge-item:hover {
            background-color: #39395a;
        }

        .dark-theme .badge-name {
            color: #cccccc;
        }

        .dark-theme .badge-date {
            color: #999999;
        }

        .dark-theme .popup {
            background-color: #292942;
            color: #ffffff;
        }

        .dark-theme .popup img {
            background-color: #1e1e2f;
        }

        .dark-theme .popup-close {
            color: #ffffff;
            background-color: #444;
        }

        .dark-theme .popup-close:hover {
            background-color: #666;
        }

        .dark-theme .overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }


        .badge-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            text-align: center;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .badge-title {
            font-size: 32px;
            margin-bottom: 30px;
            color: #333;
        }

        .badge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 30px;
            justify-content: center;
            padding: 10px;
        }

        .badge-item {
            background-color: #f9f9f9;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .badge-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .badge-image {
            width: 90px;
            height: 90px;
            margin-bottom: 15px;
            border-radius: 50%;
            border: 3px solid #e0e0e0;
        }

        .badge-name {
            font-size: 18px;
            margin: 10px 0;
            color: #555;
        }

        .badge-date {
            font-size: 14px;
            color: #777;
        }

        /* Popup Styles */
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            text-align: center;
        }

        .popup.active {
            display: block;
        }

        .popup h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }

        .popup p {
            font-size: 16px;
            margin-bottom: 20px;
        }

        .popup img {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
        }

        .popup-close {
            font-size: 16px;
            color: #333;
            background-color: #f0f0f0;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .popup-close:hover {
            background-color: #e0e0e0;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }

        .img-fluid {
            max-width: 100%;
            height: auto;
            max-width: 250px;
            margin-left: 40%;
        }

        .flashcard.flip-animation {
            animation: shake 0.1s ease-out forwards;
            /* Giảm thời gian lắc */
        }

        @keyframes shake {
            0% {
                transform: rotateY(0deg);
            }

            50% {
                transform: rotateY(10deg);
                /* Lắc nhẹ hơn */
            }

            100% {
                transform: rotateY(0deg);
            }
        }

        .flashcard.slide-out-left {
            animation: slideOutLeft 0.10s ease-out forwards;
            /* Giảm thời gian slide */
        }

        .flashcard.slide-in-right {
            animation: slideInRight 0.10s ease-out forwards;
            /* Giảm thời gian slide */
        }

        .flashcard.slide-out-right {
            animation: slideOutRight 0.10s ease-out forwards;
            /* Giảm thời gian slide */
        }

        .flashcard.slide-in-left {
            animation: slideInLeft 0.10s ease-out forwards;
            /* Giảm thời gian slide */
        }

        @keyframes slideOutLeft {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(-3%);
                /* Giảm độ dịch chuyển */
                opacity: 0;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(3%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(2%);
                /* Giảm độ dịch chuyển */
                opacity: 0;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-2%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .drag-handle {
            cursor: grab;
            font-size: 20px;
            user-select: none;
            padding: 4px 8px;
        }

        .modal {
            z-index: 1055 !important;
            overflow-y: auto;
        }

        .modal-backdrop {
            z-index: 1050 !important;
        }

        .folder-card,
        .deck-card {
            border-radius: 25px;
            /* Thay đổi giá trị tùy theo độ bo tròn bạn muốn */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* Thêm bóng đổ nếu muốn */
            overflow: hidden;
            /* Đảm bảo nội dung không bị tràn ra ngoài thẻ */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .folder-card:hover,
        .deck-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            background-color: #f8f9fa;
            /* nhẹ hơn để nổi bật */
        }

        /* 🌚 Giao diện tối */
        .dark-theme .folder-card,
        .dark-theme .deck-card {
            background-color: #2c2f33;
            color: #f1f1f1;
        }

        .dark-theme .folder-card:hover,
        .dark-theme .deck-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.05);
            background-color: #3a3d41;
        }

        .dark-theme .deck-card .card-text {
            color: whitesmoke;
        }


        .folder-card .card-text {
            white-space: normal;
        }

        .deck-card .card-text {
            display: flex;
            flex-direction: column;
            white-space: normal;
            line-height: 1.6;
            font-size: 0.95rem;
            color: #333;
        }

        .deck-category {
            display: inline-block;
            margin-top: 4px;
            padding: 2px 20px;
            border-radius: 12px;
            background-color: #28a745;
            /* Bootstrap green */
            color: #fff;
            font-weight: 500;
            font-style: italic;
            text-transform: capitalize;
            font-size: 0.9rem;
            max-width: fit-content;
        }

        .dark-theme .quiz-question {
            font-weight: bold;
            color: #ffffff;
            font-size: 1.1rem;
        }

        .quiz-question {
            color: #000000;
            font-size: 1.1rem;
        }

        /* Container form multi-choice */
        #multiForm {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* Các lựa chọn checkbox */
        #multiForm .form-check {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
            margin-bottom: 8px;
        }

        #multiForm .form-check:hover {
            background-color: #f8f9fa;
        }

        #multiForm .form-check-input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        #multiForm .form-check-label {
            font-size: 1rem;
            color: #333;
        }

        /* Nút Submit */
        #submitMulti {
            background-color: #037a89;
            border-color: #048697;
            color: #fff;
            font-weight: 500;
            border-radius: 20px;
            padding: 8px 20px;
            transition: background-color 0.2s, transform 0.1s;
        }

        #submitMulti:hover {
            background-color: #026a78;
            transform: translateY(-1px);
        }

        /* Feedback message */
        #multiFeedback {
            font-size: 0.95rem;
            font-weight: 500;
            min-height: 1.5em;
            /* giữ chỗ khi chưa có text */
        }

        #multiFeedback.text-success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
        }

        #multiFeedback.text-danger {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
        }

        /* Đảm bảo responsive */
        @media (max-width: 576px) {
            #multiForm {
                padding: 12px;
            }

            #multiForm .form-check-label {
                font-size: 0.9rem;
            }

            #submitMulti {
                width: 100%;
                text-align: center;
            }
        }

        /* Style chung cho nút Hiện đáp án */
        #revealAnswer {
            font-size: 0.9rem;
            color: #037a89;
            /* Màu chủ đạo giống nút Play */
            background: none;
            border: none;
            padding: 0;
            margin-left: 8px;
            cursor: pointer;
            text-decoration: underline;
            /* Gạch chân để giống link */
            transition: color 0.2s;
        }

        /* Hover/focus effect */
        #revealAnswer:hover,
        #revealAnswer:focus {
            color: #025f6a;
            /* Màu đậm hơn khi hover */
            outline: none;
        }

        /* Disabled state (nếu muốn tắt nút sau khi reveal) */
        #revealAnswer[disabled] {
            color: #999;
            cursor: default;
            text-decoration: none;
        }

        /* Container của đáp án đúng */
        #correctAnswer {
            font-size: 0.95rem;
            color: #333;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            margin-top: 6px;
        }

        /* Đảm bảo responsive trên mobile */
        @media (max-width: 576px) {
            #revealAnswer {
                font-size: 0.85rem;
                margin-left: 4px;
            }

            #correctAnswer {
                font-size: 0.9rem;
                padding: 6px 10px;
            }
        }

        /* CSS cho toast notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1050;
        }

        .toast {
            display: flex;
            align-items: center;
            min-width: 200px;
            margin-bottom: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.25rem;
            color: #fff;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.info {
            background: #17a2b8;
        }

        .toast.success {
            background: #28a745;
        }

        .toast.warning {
            background: #ffc107;
            color: #212529;
        }

        .toast.error {
            background: #dc3545;
        }


        /* === Modal Container === */
        .modal-impressive {
            border: none;
            border-radius: 1rem;
            overflow: hidden;
            animation: fadeInScale 0.3s ease-out;
            box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #e0f7fa 0%, #fffde7 100%);
        }

        /* === Header === */
        .header-impressive {
            position: relative;
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.6);
            border-bottom: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .icon-wrapper {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
        }

        .icon-bounce {
            font-size: 1.75rem;
            animation: bounce 1.5s infinite;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #006064;
        }

        /* === Close Button === */
        .close-impressive {
            position: absolute;
            right: 0.75rem;
            top: 0.75rem;
            font-size: 1.25rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .close-impressive:hover {
            opacity: 1;
        }

     
        .message-main {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: #004d40;
            font-weight: 500;
        }

        .message-sub {
            font-size: 1rem;
            color: #00695c;
            opacity: 0.85;
        }

        /* === Footer === */
        .footer-impressive {
            padding: 1rem 1.5rem;
            border-top: none;
            display: flex;
            justify-content: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.6);
        }

        .footer-impressive .btn {
            min-width: 140px;
            font-size: 1rem;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .footer-impressive .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }

        /* ===== Thẻ card chung ===== */
        #quizContent .card {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #quizContent .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        /* ===== Câu hỏi ===== */
        .question-text {
            font-size: 1.6rem;
            font-weight: 500;
            color: #000000;
        }

        /* ===== Nút lựa chọn ===== */
        .quiz-opt,
        .quiz-option {
            text-align: left;
            position: relative;
            padding: 12px 16px;
            font-size: 1rem;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.2s;
            color: black;
            border: 2.5px solid #d0d0d06e;
            box-shadow: #000000;
        }

        .quiz-opt:hover,
        .quiz-option:hover {
            transform: translateX(3px);
            background-color: #edefff00;
            color: black;
            border: 2px solid #4644e0;
        }

        /* ===== Đánh dấu chọn (.selected) ===== */
        .selected {
            background-color: #EDEFFF;
            border: 2px solid #4644e0;

        }

        /* ===== Đáp án đúng (.correct) ===== */
      
        /* Thêm icon ✓ */
        .correct::after {
            content: '✓';
            position: absolute;
            right: 16px;
            font-size: 1.2rem;
        }

        /* ===== Đáp án sai (.incorrect) ===== */
      

        /* Thêm icon ✗ */
        
        .incorrect::after {
            content: '✗';
            position: absolute;
            right: 16px;
            font-size: 1.2rem;
        }

        /* ===== Kết quả tổng ===== */
        #quizResults .alert {
            border-radius: 6px;
            font-weight: 500;
        }

        /* ===== Ẩn nút Nộp bài cho đến khi Test Pro ===== */
        #submitPro.d-none {
            display: none !important;
        }

        .correct {
            border-color: #3dc45a !important;
            color: #034513 !important;
            font-weight: bold;
  
        }

        .incorrect {
            border-color: #e12e3d !important;
            color: #701019 !important;
            
        }

        .text-warning {
            border-color: #be9a20 !important;
            color: #856404 !important;
            font-weight: bold;
            
        }

        .quiz-sidebar {
            position: fixed;
            top: 80px;
            right: 10px;
            z-index: 999;
            background: #f8f9fa;
            padding: 8px 6px;
            border-radius: 8px;
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
            font-size: 14px;
        }

        .quiz-sidebar .q-link {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
        }

        .quiz-sidebar .q-link:hover {
            background-color: #9aa4ae;
            cursor: pointer;
        }

        .quiz-sidebar .q-link.correct {
            color: green;
        }

        .quiz-sidebar .q-link.incorrect {
            color: orangered;
        }

 .streak-dashboard {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dashboard-header {
            background: linear-gradient(135deg, #6b8eff, #242eee);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="60" cy="30" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="30" cy="70" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>');
            opacity: 0.3;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }

        .dashboard-subtitle {
            font-size: 1.1rem;
            margin-top: 8px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .table-wrapper {
            padding: 30px;
        }

        .streak-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            background: white;
        }

        .table-header {
            background: linear-gradient(135deg, #4c63d2, #6c5ce7);
            color: white;
        }

        .table-header th {
            padding: 20px 15px;
            font-weight: 600;
            font-size: 1rem;
            text-align: center;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
        }

        .table-header th:first-child {
            border-top-left-radius: 12px;
        }

        .table-header th:last-child {
            border-top-right-radius: 12px;
        }

        .table-body tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid #e8ecf4;
        }

        .table-body tr:hover {
            background: linear-gradient(135deg, #f8f9ff, #e8ecf4);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .table-body tr:last-child {
            border-bottom: none;
        }

        .table-body td {
            padding: 18px 15px;
            text-align: center;
            font-size: 0.95rem;
            color: #2d3748;
        }

        .rank-cell {
            font-weight: 700;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #ffd700, #ffb347);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .streak-count {
            font-weight: 600;
            font-size: 1.1rem;
            color: #4c63d2;
        }

        .streak-type {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-study {
            background: linear-gradient(135deg, #a8e6cf, #7fcdcd);
            color: #2d5a27;
        }

        .type-exercise {
            background: linear-gradient(135deg, #ffd3a5, #fd9853);
            color: #8b4513;
        }

        .type-work {
            background: linear-gradient(135deg, #a8c8ec, #7d8dc1);
            color: #2c3e50;
        }

        .type-habit {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: #8b0000;
        }


        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .empty-state-subtext {
            font-size: 0.9rem;
            opacity: 0.7;
        }

         .streak-dashboard {
            animation: fadeInUp 0.6s ease-out;
        }



        /* Các phần khác tương tự */
    </style>
</head>

<body>
    <div class="container mt-auto">
        <div id="toastContainer" class="toast-container"></div>
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <img src="flash-cards.png" alt="flashcard-picture" class="fc-pic">
            <span class="fc-text">
                <strong>
                    <span class="lofcad-text">LOFCAD</span>
                    <span class="plus-text">PLUS</span>
                </strong>
            </span>
            <li class="nav-item ml-auto">
                <a class="nav-link active" id="folders-tab" data-toggle="tab" href="#folders" role="tab">
                    <i class="fas fa-folder"></i>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="decks-tab" data-toggle="tab" href="#decks" role="tab">
                    <i class="fas fa-layer-group"></i>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="create-tab" data-toggle="tab" href="#create" role="tab">
                    <i class="fas fa-plus"></i>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="study-tab" data-toggle="tab" href="#study" role="tab">
                    <i class="fas fa-book"></i>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="quiz-tab" data-toggle="tab" href="#quiz" role="tab">
                    <i class="fas fa-tasks"></i>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link" id="achievements-tab" data-toggle="tab" href="#achievements" role="tab">
                    <i class="fas fa-trophy"></i>
                </a>
            </li>

            <li class="nav-item">
                <nav>
                    <div class="theme-toggle-container">
                        <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
                            <div class="toggle-track">
                                <div class="toggle-thumb">
                                    <svg class="sun-icon" viewBox="0 0 24 24" fill="none">
                                        <path
                                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                        <circle cx="12" cy="12" r="4" fill="currentColor" />
                                    </svg>
                                    <svg class="moon-icon" viewBox="0 0 24 24" fill="none">
                                        <path
                                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                                            fill="currentColor" />
                                    </svg>
                                </div>
                            </div>
                        </button>
                    </div>
            </li>
            <li class="nav-item">
                <button id="toggleEffect" class="btn btn-success">🧩</button>
                <div id="effectContainer"></div>

            </li>

        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="myTabContent">
            <!-- Folders Tab -->
            <div class="tab-pane fade show active" id="folders" role="tabpanel">

                <!-- 🔥 Streak Display -->
                <div id="streak-display"
                    style="position: absolute; top: 100px; right: 100px; background: #ffefc1; padding: 10px 16px; border-radius: 10px; font-weight: bold; color: #e67300; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10;">
                    🔥 Streak: <span id="streak-count">0</span> ngày
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Tạo thư mục mới</h5>
                                <form id="newFolderForm">
                                    <div class="form-group">
                                        <input type="text" class="form-control" id="folderName"
                                            placeholder="Tên thư mục" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Tạo mới</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 mt-4">
                        <h4>Danh sách Thư mục</h4>
                        <div class="row" id="foldersList"></div>
                    </div>
                </div>
            </div>


            <!-- Decks Tab -->
            <div class="tab-pane fade" id="decks" role="tabpanel">
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card deck-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Tạo bộ thẻ mới</h5>
                                <form id="newDeckForm">
                                    <div class="form-group">
                                        <input type="text" class="form-control" id="deckName" placeholder="Tên bộ thẻ"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label for="selectFolder">Chọn thư mục:</label>
                                        <select class="form-control" id="selectFolder" required>
                                            <!-- Các thư mục sẽ được thêm vào đây -->
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Tạo mới</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                            <h4 class="mb-2 mb-md-0">Bộ thẻ của bạn</h4>
                            <input type="text" class="form-control w-100 w-md-50" id="searchDeckInput"
                                placeholder="🔍 Tìm bộ thẻ..." style="max-width: 300px;">
                        </div>
                        <div class="row" id="decksList"></div>
                    </div>


                </div>
            </div>

            <!-- Create Tab -->
            <div class="tab-pane fade" id="create" role="tabpanel">
                <div class="card mt-4">
                    <div class="card-body">
                        <h4>Nhập từ tệp JSON</h4>
                        <p>Tải lên tệp JSON đã xuất từ Quizlet:</p>
                        <input type="file" id="jsonFileInput" accept=".json" class="form-control-file">
                        <button class="btn btn-primary mt-3" id="importJsonBtn">Nhập Tệp</button>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h4>Nhập thủ công</h4>
                                <form id="cardForm">
                                    <div class="form-group">
                                        <label>Thuật ngữ:</label>
                                        <textarea class="form-control" id="term" rows="3" required></textarea>
                                        <input type="file" class="form-control-file mt-2" id="termImage"
                                            accept="image/*">
                                        <img id="imagePreview" class="d-none img-fluid mt-2" alt="Preview Term Image">
                                    </div>
                                    <div class="form-group">
                                        <label>Định nghĩa:</label>
                                        <textarea class="form-control" id="definition" rows="3" required></textarea>
                                        <!-- Thêm trường tải lên ảnh cho định nghĩa -->
                                        <input type="file" class="form-control-file mt-2" id="definitionImage"
                                            accept="image/*">
                                        <img id="definitionImagePreview" class="d-none img-fluid mt-2"
                                            alt="Preview Definition Image">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Thêm thẻ</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h4>Nhập hàng loạt</h4>
                                <div class="form-group">
                                    <label>Dán dữ liệu:</label>
                                    <textarea class="form-control" id="bulkInput" rows="10"
                                        placeholder="Ví dụ: Thuật ngữ ** Định nghĩa"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Phân cách thuật ngữ và định nghĩa:</label>
                                    <input type="text" class="form-control" id="termSeparator" value="**"
                                        placeholder="Ví dụ: **">
                                </div>
                                <div class="form-group">
                                    <label>Phân cách giữa các thẻ:</label>
                                    <input type="text" class="form-control" id="cardSeparator" value="\n\n"
                                        placeholder="Ví dụ: \n\n">
                                </div>
                                <button class="btn btn-primary" id="importBtn">Nhập</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Study Tab -->
            <div class="tab-pane fade" id="study" role="tabpanel">
                <div class="row mt-1">
                    <div class="col-md-10 mx-auto">
                        <div class="study-mode">

                            <div class="control-panel">

                                <!-- Hàng nút control -->
                                <div class="d-flex justify-content-between align-items-center flex-wrap mb-2">
                                    <!-- Term / Def -->
                                    <div class="d-flex align-items-center flex-wrap gap-2">
  <button class="defbut btn btn-outline-dark btn-sm" id="showTermFirst" title="Thuật ngữ trước">
    <i class="fas fa-font"></i>
  </button>
  <button class="meanbut btn btn-outline-dark btn-sm" id="showDefFirst" title="Định nghĩa trước">
    <i class="fas fa-book"></i>
  </button>

  <button class="btn btn-secondary btn-sm" id="decreaseFontBtn" title="Giảm chữ">
    <i class="fas fa-minus"></i>
  </button>
  <button class="btn btn-secondary btn-sm" id="increaseFontBtn" title="Tăng chữ">
    <i class="fas fa-plus"></i>
  </button>

<button class="autoplayBut btn btn-outline-dark btn-sm" id="autoPlayBtn" title="Tự động">
  <i class="fas fa-play"></i>
</button>


  <!-- Tốc độ -->
  <div class="d-flex align-items-center">
    <input type="range" class="form-range" id="speedRange" min="1" max="10" value="5" style="width: 150px;">
    <small class="text-white ms-2">Tốc độ: <span id="speedValue">5</span>s</small>
  </div>
</div>


                                    <!-- Ngôn ngữ + Đọc -->
                                    <div class="responSamsung d-flex align-items-center flex-wrap gap-2">
                                             <label for="readCount" class="mb-0">Số lần:</label>
  <input type="number" id="readCount" min="1" value="1" class="form-control form-control-sm mx-2" style="width:5em;"/>
                                        <select class="form-control form-control-sm d-inline-block w-auto mr-2"
                                            id="languageSelect" title="Ngôn ngữ">
                                            <option value="none">--</option>
                                            <option value="vi-VN">🇻🇳</option>
                                            <option value="en-US">🇺🇸</option>
                                            <option value="ja-JP">🇯🇵</option>
                                            <option value="zh-CN">🇨🇳</option>
                                            <option value="ko-KR">🇰🇷</option>

                                        </select>
                                        <button class="btn btn-info btn-sm mr-2" id="speakBtn" title="Đọc">
                                            <i class="fas fa-volume-up"></i>
                                        </button>
                                     

                                        <button class="btn btn-danger btn-sm d-none" id="stopSpeakBtn" title="Dừng">
                                            <i class="fas fa-stop"></i>
                                        </button>
                                        <button class="btn btn-warning btn-sm ml-2" id="fullscreenBtn"
                                            title="Toàn màn hình">
                                            <i class="fas fa-expand"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Tiêu đề xuống hàng riêng -->
                                <div class="text-center mb-3">
                                    <h4 id="currentDeckName">
                                        <strong>Card set:</strong> <span></span>
                                    </h4>
                                </div>



                                <!-- Tốc độ -->
                                <div class="mt-2">
                                  
                                </div>

                            </div>



                            <div class="flashcard" id="flashcard">
                                <div class="flashcard-inner">
                                    <div class="flashcard-front">
                                        <pre id="termContent"></pre>
                                    </div>
                                    <div class="flashcard-back">
                                        <pre id="definitionContent"></pre>
                                    </div>
                                </div>
                            </div>

                            <!-- Nút Prev/Next và Tăng/Giảm chữ xuống dưới cùng -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div></div> <!-- Trống bên trái -->
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <!-- Trống bên trái -->
                                    <div></div>

                                    <!-- Căn chỉnh ngang đều -->
                                    <div class="d-flex justify-content-center align-items-center w-100">
                                        <button class="prevbut btn btn-secondary btn-sm mx-2" id="prevCard"
                                            title="Trước">
                                            <i class="fas fa-arrow-left"></i>
                                        </button>
                                        <div class="progress-info text-white mb-1.5 mx-2">
                                            <span id="cardProgress">0/0</span>
                                        </div>
                                        <button class="nextbut btn btn-secondary btn-sm mx-2" id="nextCard"
                                            title="Tiếp">
                                            <i class="fas fa-arrow-right"></i>
                                        </button>
                                          
                                    </div>
                                    <div></div> <!-- Trống bên phải -->
                                </div>
                                <div class="d-flex align-items-center">
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>



            <!-- Quiz Tab -->
            <div class="tab-pane fade" id="quiz" role="tabpanel">

                <div class="row mt-2">
                    <div class="col-md-8 mx-auto">
                        <div class="quiz-top-actions">
                            <button class="btn btn-info" id="toggleQuiz">
                                <span id="toggleIcon">+</span>
                            </button>
                            <!-- Bỏ qua: dùng màu phụ nhẹ nhàng -->
                            <button class="btn btn-warning d-none" id="skipQuestion">Bỏ qua</button>


                            <!-- Nộp bài: dùng màu thành công rõ ràng -->
                            <button class="btn btn-success d-none" id="submitQuiz">Nộp bài</button>
                            <!-- Sau nút Nộp bài -->


                        </div>
                        <div class="quiz-mode">

                            <div class="form-group">
                                <label>Số câu hỏi:</label>
                                <input type="number" class="form-control" id="questionCount" min="1" value="100">
                            </div>
                            <div class="form-group">
                                <label>Chọn từ câu số:</label>
                                <input type="number" class="form-control" id="startFrom" min="1" value="1">
                            </div>
                            <div class="form-group">
                                <label>Đến câu số:</label>
                                <input type="number" class="form-control" id="endAt" min="1" value="10">
                            </div>

                            <div class="form-group">
                                <div class="custom-control custom-radio">
                                    <input type="radio" id="multipleChoice" name="quizType" class="custom-control-input"
                                        checked>
                                    <label class="custom-control-label" for="multipleChoice">Trắc nghiệm</label>
                                </div>
                                <div class="custom-control custom-radio">
                                    <input type="radio" id="writtenAnswer" name="quizType" class="custom-control-input">
                                    <label class="custom-control-label" for="writtenAnswer">Tự luận</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="custom-control custom-radio">
                                    <input type="radio" id="termTodef" name="direction" class="custom-control-input"
                                        checked>
                                    <label class="custom-control-label" for="termTodef">Thuật ngữ → Định nghĩa</label>
                                </div>
                                <div class="custom-control custom-radio">
                                    <input type="radio" id="defToterm" name="direction" class="custom-control-input">
                                    <label class="custom-control-label" for="defToterm">Định nghĩa → Thuật ngữ</label>
                                </div>
                            </div>
                            <!-- Audio Quiz Controls -->
                            <div class="form-group">
                                <label for="quizLanguage">Chọn ngôn ngữ nghe:</label>
                                <select id="quizLanguage" class="form-control"></select>
                            </div>
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="audioQuiz">
                                <label class="form-check-label" for="audioQuiz">Quiz bằng âm thanh</label>
                            </div>
                            <!-- Đặt gần khu vực khởi động quiz -->
                            <div class="form-check my-2">
                                <input class="form-check-input" type="checkbox" id="shuffleQuestions">
                                <label class="form-check-label" for="shuffleQuestions">
                                    Trộn câu hỏi
                                </label>
                            </div>

                            <button class="btn btn-primary" id="startQuiz">Bắt đầu</button>
                            <button class="btn btn-secondary" id="shuffleQuiz">Trộn câu hỏi</button>
                            <!-- Nút để khởi động Test Pro -->
                            <button id="testProBtn" class="btn btn-danger">Test Pro</button>


                        </div>
                    </div>
                </div>

                <div id="quizContent" class="mt-2">
                </div>
                <!-- Nút Nộp bài, ẩn ban đầu -->
                <button id="submitPro" class="btn btn-success d-none">Nộp bài</button>

                <!-- Kết quả quiz -->
                <div id="quizResults" class="mt-4"></div>
                <div id="quizSidebar" class="quiz-sidebar">
                    <!-- sẽ được tạo động bằng JS -->
                </div>

            </div>
            <!-- Thêm vào phần Tab content -->
            <div class="tab-pane fade" id="achievements" role="tabpanel">
   <div class="container py-4">
<div class="streak-dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title">🔥 Streak Dashboard</h1>
            <p class="dashboard-subtitle">Theo dõi các chuỗi học tập</p>
        </div>
        
        <div class="table-wrapper">
            <table class="streak-table" id="streakTable">
                <thead class="table-header">
                    <tr>
                        <th>🏅 Hạng</th>
                        <th>Số ngày streak</th>
                        <th>Loại xếp hạng</th>
                    </tr>
                </thead>
                <tbody class="table-body">
                    <!-- Sample data for demonstration -->
                    <tr>
                        <td class="rank-cell">1</td>
                        <td class="streak-count">5 ngày</td>
               
                    </tr>
                    <tr>
                        <td class="rank-cell">2</td>
                        <td class="streak-count">4 ngày</td>
    
                    </tr>
                    <tr>
                        <td class="rank-cell">3</td>
                        <td class="streak-count">3 ngày</td>
           
                    </tr>
                    <tr>
                        <td class="rank-cell">4</td>
                        <td class="streak-count">2 ngày</td>
                   
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Toast notification container -->
    <div class="notification-container" id="streak-toast-container">
        <!-- Toast notifications will be inserted here -->
    </div>
    </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <h4>Thành tựu của bạn</h4>
                        <div class="badge-container">
                            <div class="badge-grid">
                                <div class="badge-item"
                                    onclick="showPopup('tich.png', 'Học viên tích cực', '1 tháng 1, 2025', 'Tặng thưởng vì có sự tích cực, kiên trì trong học tập.')">
                                    <img src="tich.png" alt="Badge 1" class="badge-image">
                                    <h3 class="badge-name">Học viên tích cực</h3>
                                    <p class="badge-date">1 tháng 1, 2025</p>
                                </div>
                                <div class="badge-item"
                                    onclick="showPopup('cre.png', 'Nhà tạo học phần', '1 tháng 1, 2025', 'Tặng thưởng vì tạo học phần đầu tiên.')">
                                    <img src="cre.png" alt="Badge 2" class="badge-image">
                                    <h3 class="badge-name">Nhà tạo học phần</h3>
                                    <p class="badge-date">1 tháng 1, 2025</p>
                                </div>
                                <div class="badge-item"
                                    onclick="showPopup('cu.png', 'Cú đêm thức khuya', '1 tháng 1, 2025', 'Tặng thưởng vì đã học bài lúc đêm muộn! Luôn luôn nỗ lực.')">
                                    <img src="cu.png" alt="Badge 3" class="badge-image">
                                    <h3 class="badge-name">Cú đêm thức khuya</h3>
                                    <p class="badge-date">1 tháng 1, 2025</p>
                                </div>
                                <div class="badge-item"
                                    onclick="showPopup('chim.png', 'Chim sâu dậy sớm', '1 tháng 1, 2025', 'Tặng thưởng vì đã học bài vào sáng sớm!')">
                                    <img src="chim.png" alt="Badge 4" class="badge-image">
                                    <h3 class="badge-name">Chim sâu dậy sớm</h3>
                                    <p class="badge-date">1 tháng 1, 2025</p>
                                </div>
                                <div class="badge-item"
                                    onclick="showPopup('1k.png', '1.000 học phần đã học', '1 tháng 1, 2025', 'Tặng thưởng vì đã học 1.000 học phần!')">
                                    <img src="1k.png" alt="Badge 5" class="badge-image">
                                    <h3 class="badge-name">1.000 học phần đã học</h3>
                                    <p class="badge-date">1 tháng 1, 2025</p>
                                </div>
                                <div class="badge-item"
                                    onclick="showPopup('j.png', 'Đom đóm', '1 tháng 1, 2025', 'Tặng thưởng vì đã nghe Thiên Lý ơi')">
                                    <img src="j.png" alt="Badge 6" class="badge-image">
                                    <h3 class="badge-name">Đom đóm</h3>
                                    <p class="badge-date">1 tháng 1, 2025</p>
                                </div>
                            </div>
                        </div>

                        <!-- Popup and Overlay -->
                        <div class="overlay" id="overlay" onclick="hidePopup()"></div>
                        <div class="popup" id="popup">
                            <img id="popup-image" src="" alt="Badge">
                            <h2 id="popup-title"></h2>
                            <p id="popup-date"></p>
                            <p id="popup-description"></p>
                            <button class="popup-close" onclick="hidePopup()">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal để chỉnh sửa bộ thẻ -->
            <div class="modal fade" id="editDeckModal" tabindex="-1" role="dialog" aria-labelledby="editDeckModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document"> <!-- Changed to modal-lg for better space -->
                    <div class="modal-content">
                        <form id="editDeckForm">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editDeckModalLabel">Chỉnh sửa Bộ thẻ</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" id="originalDeckName">
                                <div class="form-group">
                                    <label for="editDeckName">Tên bộ thẻ:</label>
                                    <input type="text" class="form-control" id="editDeckName" required>
                                </div>
                                <!-- Dropdown để chọn thư mục mới -->
                                <div class="form-group">
                                    <label for="editSelectFolder">Chọn thư mục mới:</label>
                                    <select class="form-control" id="editSelectFolder" required>
                                        <!-- Các thư mục sẽ được thêm vào đây -->
                                    </select>
                                </div>
                                <!-- Nút chuyển thư mục -->
                                <button type="button" class="btn btn-secondary mb-3" id="moveDeckBtn">Chuyển Thư
                                    Mục</button>
                                <!-- Nút xuất bộ thẻ ra Word -->
                                <button type="button" class="btn btn-success mb-3" id="exportDeckBtn">Xuất bộ thẻ ra
                                    Word</button>
                                    <!-- Nút xuất JSON -->
<button type="button" class="btn btn-warning mb-3 ml-2" id="exportJsonBtn">Xuất ra JSON</button>

                                <!-- Nút copy bộ thẻ -->
                                <button type="button" class="btn btn-info mb-3 ml-2" id="copyDeckBtn">Copy bộ
                                    thẻ</button>
                                <!-- Flashcard Management Section -->
                                <h5>Quản lý Flashcards</h5>
                                <div id="flashcardsList" class="mb-3">
                                    <!-- Existing flashcards sẽ được liệt kê ở đây -->
                                </div>
                                <button type="button" class="btn btn-primary" id="addFlashcardBtn">Thêm Flashcard
                                    Mới</button>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                                <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal để chỉnh sửa Thư mục -->
            <div class="modal fade" id="editFolderModal" tabindex="-1" role="dialog"
                aria-labelledby="editFolderModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <form id="editFolderForm">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editFolderModalLabel">Chỉnh sửa Thư mục</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" id="originalFolderName">
                                <div class="form-group">
                                    <label for="editFolderName">Tên thư mục:</label>
                                    <input type="text" class="form-control" id="editFolderName" required>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Modal Chỉnh Sửa Flashcard -->
            <div class="modal fade" id="editFlashcardModal" tabindex="-1" role="dialog"
                aria-labelledby="editFlashcardModalLabel" aria-hidden="true" style="z-index: 1051;">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <form id="editFlashcardForm">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editFlashcardModalLabel">Chỉnh Sửa Flashcard</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <!-- Thuật Ngữ -->
                                <div class="form-group">
                                    <label for="editTerm">Thuật Ngữ</label>
                                    <textarea class="form-control" id="editTerm" rows="3" required
                                        style="white-space: pre-wrap;"></textarea>
                                </div>

                                <!-- Định Nghĩa -->
                                <div class="form-group">
                                    <label for="editDefinition">Định Nghĩa</label>
                                    <textarea class="form-control" id="editDefinition" rows="3" required
                                        style="white-space: pre-wrap;"></textarea>
                                </div>

                                <!-- Hình Ảnh Thuật Ngữ -->
                                <div class="form-group">
                                    <label for="editTermImage">Hình Ảnh Thuật Ngữ (Tùy Chọn)</label>
                                    <input type="file" class="form-control-file" id="editTermImage" accept="image/*">
                                    <img id="editImagePreview" src="#" alt="Preview Term Image"
                                        class="img-fluid mt-2 d-none">
                                </div>

                                <!-- Thêm Hình Ảnh Định Nghĩa -->
                                <div class="form-group">
                                    <label for="editDefinitionImage">Hình Ảnh Định Nghĩa (Tùy Chọn)</label>
                                    <input type="file" class="form-control-file" id="editDefinitionImage"
                                        accept="image/*">
                                    <img id="editDefinitionImagePreview" src="#" alt="Preview Definition Image"
                                        class="img-fluid mt-2 d-none">
                                </div>

                                <!-- Hidden Input để lưu chỉ số flashcard -->
                                <input type="hidden" id="editFlashcardIndex">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                                <button type="button" class="btn btn-primary" id="saveFlashcardBtn">Lưu Thay
                                    Đổi</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>


            <!-- Modal hiển thị khi hoàn thành flashcards -->
            <!-- HTML Modal -->
            <div class="modal fade" id="completionModal" tabindex="-1" role="dialog"
                aria-labelledby="completionModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content modal-impressive">
                        <div class="modal-header header-impressive">
                            <div class="icon-wrapper">
                                <span class="icon-bounce">🎉</span>
                            </div>
                            <h5 class="modal-title" id="completionModalLabel">Hoàn thành!</h5>
                            <button type="button" class="close close-impressive" data-dismiss="modal" aria-label="Đóng">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body body-impressive">
                            <p class="message-main">Bạn đã hoàn thành tất cả các flashcard!</p>
                            <p class="message-sub">Bạn muốn học lại từ đầu hay dừng ở vị trí cuối cùng?</p>
                        </div>
                        <div class="modal-footer footer-impressive">
                            <button type="button" class="btn btn-outline-primary btn-lg" id="modalRestartStudyBtn">
                                Học lại từ đầu
                            </button>
                            <button type="button" class="btn btn-primary btn-lg" id="modalStartQuizBtn">
                                Dừng tại đây
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Các thư viện cần thiết -->
            <script
                src="https://cdnjs.cloudflare.com/ajax/libs/string-similarity/4.0.4/string-similarity.min.js"></script>
            <!-- Thư viện JS cho việc xuất Word -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
            <!-- Thêm thư viện docx và FileSaver.js -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.1/docx.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

            <script>

                let decks = {};
                let folders = {}; // To store folders
                let currentDeck = null;
                let flashcards = [];
                let currentCard = 0;
                let autoPlayInterval;
                let quizQuestions = [];
                let currentQuestion = 0;
                let score = 0;
                let currentSpeech = null;
                let quizResults = {
                    correct: [],
                    incorrect: []
                };

                const correctSound = new Audio('correct.mp3');
                const incorrectSound = new Audio('incorrect.mp3');

                function showNotification(message, type = 'info', duration = 3000) {
                    const container = document.getElementById('toastContainer');
                    if (!container) return;

                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.textContent = message;
                    container.appendChild(toast);

                    // Cho effect hiện
                    requestAnimationFrame(() => {
                        toast.classList.add('show');
                    });

                    // Tự ẩn sau duration
                    setTimeout(() => {
                        toast.classList.remove('show');
                        // Remove khỏi DOM sau transition
                        toast.addEventListener('transitionend', () => {
                            toast.remove();
                        });
                    }, duration);
                }

                function handleOptionClick(event) {
                    const selectedOption = event.currentTarget.getAttribute('data-letter');

                    if (selectedOption === quizData.correctOption) {
                        correctSound.play().catch(error => console.error("Error playing correct sound:", error));
                        event.currentTarget.classList.add('correct');
                    } else {
                        incorrectSound.play().catch(error => console.error("Error playing incorrect sound:", error));
                        event.currentTarget.classList.add('incorrect');
                    }

                    disableQuizOptions();
                }
                // --- 2.1. Load Web Speech voices và populate dropdown ---
                let availableVoices = [];
                function populateVoices() {
                    availableVoices = speechSynthesis.getVoices();
                    const sel = document.getElementById('quizLanguage');
                    sel.innerHTML = availableVoices
                        .map(v => `<option value="${v.name}">[${v.lang}] ${v.name}</option>`)
                        .join('');
                }
                speechSynthesis.onvoiceschanged = populateVoices;
                populateVoices();

                // --- 2.2. Event listener để khi đổi voice, quiz audio sẽ phát lại câu hiện tại ---
                document.getElementById('quizLanguage')
                    .addEventListener('change', () => {
                        if (document.getElementById('audioQuiz').checked) {
                            showQuestion();
                        }
                    });



                // Hàm vô hiệu hóa các lựa chọn sau khi đã chọn
                function disableQuizOptions() {
                    document.querySelectorAll('.quiz-option').forEach(option => {
                        option.removeEventListener('click', handleOptionClick);
                        option.style.pointerEvents = 'none'; // Vô hiệu hóa sự kiện click
                    });
                }

                // Gán sự kiện click cho các phần tử đáp án
                document.querySelectorAll('.quiz-option').forEach(option => {
                    option.addEventListener('click', handleOptionClick);
                });

                // Variable to store current font size
                let currentFontSize = 16; // Default font size (16px)

                // Hàm áp dụng kích thước font cho flashcard
                function applyFontSize() {
                    const flashcardElements = document.querySelectorAll('.flashcard-front, .flashcard-back');
                    flashcardElements.forEach(el => {
                        el.style.fontSize = `${currentFontSize}px`;
                    });
                }

                // Hàm tăng kích thước font
                function increaseFontSize() {
                    if (currentFontSize < 100) { // Maximum 100px
                        currentFontSize += 2;
                        applyFontSize();
                        saveFontSize();
                    }
                }

                // Hàm giảm kích thước font
                function decreaseFontSize() {
                    if (currentFontSize > 10) { // Minimum 10px
                        currentFontSize -= 2;
                        applyFontSize();
                        saveFontSize();
                    }
                }

                // Hàm lưu kích thước font vào localStorage
                function saveFontSize() {
                    localStorage.setItem('flashcardFontSize', currentFontSize);
                }

                // Hàm khôi phục kích thước font từ localStorage
                function restoreFontSize() {
                    const savedFontSize = localStorage.getItem('flashcardFontSize');
                    if (savedFontSize) {
                        currentFontSize = parseInt(savedFontSize, 10);
                        applyFontSize();
                    }
                }

                // Thêm sự kiện cho nút tăng/giảm kích thước font
                document.getElementById('increaseFontBtn').addEventListener('click', increaseFontSize);
                document.getElementById('decreaseFontBtn').addEventListener('click', decreaseFontSize);

                // Khôi phục kích thước font khi tải trang
                restoreFontSize();

                // Hàm khởi tạo ứng dụng
                function initializeApp() {
                    // Khôi phục dữ liệu từ localStorage nếu có
                    const savedData = localStorage.getItem('flashcardData');
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        decks = parsedData.decks || {};
                        folders = parsedData.folders || {};
                        updateFoldersList();
                        updateDecksList();
                        updateFolderOptions();
                    }

                    // Tự động lưu dữ liệu mỗi 5 giây
                    setInterval(() => {
                        localStorage.setItem('flashcardData', JSON.stringify({ decks, folders }));
                    }, 5000);
                }

                initializeApp();

                // =================== Handling Folders ===================

                // Khi người dùng tạo thư mục mới
                document.getElementById('newFolderForm')?.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const name = document.getElementById('folderName').value.trim();
                    if (name) {
                        if (folders[name]) {
                            alert('Thư mục này đã tồn tại.');
                            return;
                        }
                        folders[name] = {
                            decks: []
                        };
                        updateFoldersList();
                        updateFolderOptions();
                        this.reset();
                        checkAchievements(); // Kiểm tra thành tựu sau khi tạo thư mục
                    }
                });

                // Hàm cập nhật danh sách thư mục
                function updateFoldersList() {
                    const foldersList = document.getElementById('foldersList');
                    foldersList.innerHTML = '';

                    Object.keys(folders).forEach(folderName => {
                        const folder = folders[folderName];
                        const col = document.createElement('div');
                        col.className = 'col-md-4 mb-4';
                        col.innerHTML = `
            <div class="card folder-card h-100 hover-shadow" onclick="selectFolder('${folderName}')" style="cursor: pointer;">
                <div class="card-body">
                    <div class="folder-header d-flex align-items-center mb-3">
                        <i class="fas fa-folder folder-icon mr-2"></i>
                        <h5 class="card-title mb-0">${folderName}</h5>
                    </div>
                    <p class="card-text">
                        ${folder.decks.length} bộ thẻ
                    </p>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-warning btn-sm mr-2" onclick="event.stopPropagation(); openEditFolderModal('${folderName}')">
                            <i class="fas fa-edit"></i> Chỉnh sửa
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteFolder('${folderName}')">
                            <i class="fas fa-trash-alt"></i> Xóa
                        </button>
                    </div>
                </div>
            </div>
        `;
                        foldersList.appendChild(col);
                    });
                }


                // Hàm cập nhật các tùy chọn thư mục trong dropdown
                function updateFolderOptions() {
                    const selectFolder = document.getElementById('selectFolder');
                    if (!selectFolder) return;
                    selectFolder.innerHTML = '';
                    Object.keys(folders).forEach(folderName => {
                        selectFolder.innerHTML += `<option value="${folderName}">${folderName}</option>`;
                    });

                    // Cập nhật dropdown trong modal chỉnh sửa bộ thẻ
                    const editSelectFolder = document.getElementById('editSelectFolder');
                    if (editSelectFolder) {
                        editSelectFolder.innerHTML = '';
                        Object.keys(folders).forEach(folderName => {
                            editSelectFolder.innerHTML += `<option value="${folderName}">${folderName}</option>`;
                        });
                    }
                }

                // Hàm chọn thư mục để xem các bộ thẻ bên trong
                function selectFolder(folderName) {
                    // Hiển thị các bộ thẻ trong thư mục này
                    currentDeck = null;
                    flashcards = [];
                    const decksList = document.getElementById('decksList');
                    decksList.innerHTML = '';

                    folders[folderName].decks.forEach(deckName => {
                        const deck = decks[deckName];
                        const col = document.createElement('div');
                        col.className = 'col-md-4 mb-4';
                        col.innerHTML = `
            <div class="card deck-card h-100" onclick="selectDeck('${deckName}')" style="cursor: pointer;">
                <div class="card-body">
                    <div class="deck-header d-flex align-items-center mb-3">
                        <i class="fas fa-layer-group deck-icon mr-2"></i>
                        <h5 class="card-title mb-0">${deckName}</h5>
                    </div>
                    <p class="card-text">
                        ${deck.cards.length} thẻ<br>
                        Tạo ngày: ${new Date(deck.createDate).toLocaleDateString()}
                    </p>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-warning btn-sm mr-2" onclick="event.stopPropagation(); openEditDeckModal('${deckName}')"><i class="fas fa-edit"></i> Chỉnh sửa</button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteDeck('${deckName}')"><i class="fas fa-trash-alt"></i> Xóa</button>
                    </div>
                </div>
            </div>
        `;
                        decksList.appendChild(col);
                    });

                    // Chuyển sang tab "Bộ thẻ"
                    $('#decks-tab').tab('show');
                }


                // Hàm mở modal chỉnh sửa thư mục
                function openEditFolderModal(folderName) {
                    document.getElementById('originalFolderName').value = folderName;
                    document.getElementById('editFolderName').value = folderName;
                    $('#editFolderModal').modal('show');
                }

                // Sự kiện khi chỉnh sửa thư mục
                document.getElementById('editFolderForm')?.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const originalName = document.getElementById('originalFolderName').value;
                    const newName = document.getElementById('editFolderName').value.trim();
                    if (newName && newName !== originalName) {
                        if (folders[newName]) {
                            showNotification('Tên thư mục đã được sử dụng.', 'info');

                            return;
                        }
                        folders[newName] = folders[originalName];
                        // Cập nhật tên thư mục trong các bộ thẻ
                        folders[newName].decks.forEach(deckName => {
                            decks[deckName].category = newName;
                        });
                        delete folders[originalName];
                        updateFoldersList();
                        updateFolderOptions();
                        updateDecksList();
                        $('#editFolderModal').modal('hide');
                    }
                });

                // Hàm xóa thư mục
                function deleteFolder(folderName) {
                    if (folders[folderName].decks.length > 0) {
                        showNotification('Không thể xóa thư mục chứa bộ thẻ. Vui lòng di chuyển bộ thẻ ra khỏi thư mục trước.', 'warning');

                        return;
                    }
                    if (confirm(`Bạn có chắc muốn xóa thư mục "${folderName}"?`)) {
                        delete folders[folderName];
                        updateFoldersList();
                        updateFolderOptions();
                    }
                }

                // =================== Handling Decks ===================

                // Khi người dùng tạo bộ thẻ mới
                document.getElementById('newDeckForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    const name = document.getElementById('deckName').value.trim();
                    const folderName = document.getElementById('selectFolder').value;
                    if (name) {
                        if (decks[name]) {

                            showNotification('Bộ thẻ này đã tồn tại', 'info');
                            return;
                        }
                        decks[name] = {
                            cards: [],
                            createDate: new Date().toISOString(),
                            category: folderName
                        };
                        // Thêm bộ thẻ vào thư mục
                        if (!folders[folderName]) {
                            folders[folderName] = { decks: [] };
                        }
                        folders[folderName].decks.push(name);
                        currentDeck = name;
                        updateDecksList();
                        updateFoldersList();
                        this.reset();
                        // Chuyển sang tab "Học"
                        $('#study-tab').tab('show');
                        checkAchievements(); // Kiểm tra thành tựu sau khi tạo bộ thẻ
                    }
                });

                function updateDecksList() {
                    const decksList = document.getElementById('decksList');
                    if (!decksList) return;
                    decksList.innerHTML = '';

                    const renderDeckCard = (deckName, deck) => {
                        const col = document.createElement('div');
                        col.className = 'col-md-4 mb-4';
                        col.innerHTML = `
            <div class="card deck-card h-100" onclick="selectDeck('${deckName}')" style="cursor: pointer;">
                <div class="card-body">
                    <h5 class="card-title">${deckName}</h5>
                    <p class="card-text">
                        ${deck.cards.length} thẻ<br>
                        Tạo ngày: ${new Date(deck.createDate).toLocaleDateString()}<br>
                        <span class="deck-category">${deck.category}</span>
                    </p>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-warning btn-sm mr-2" onclick="event.stopPropagation(); openEditDeckModal('${deckName}')"><i class="fas fa-edit"></i> Chỉnh sửa</button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteDeck('${deckName}')"><i class="fas fa-trash-alt"></i> Xóa</button>
                    </div>
                </div>
            </div>
        `;
                        decksList.appendChild(col);
                    };

                    if (currentDeck) {
                        renderDeckCard(currentDeck, decks[currentDeck]);
                    } else {
                        Object.keys(decks).forEach(deckName => {
                            renderDeckCard(deckName, decks[deckName]);
                        });
                    }
                }

                // Hàm chọn bộ thẻ để học
                function selectDeck(deckName) {
                    currentDeck = deckName;
                    flashcards = decks[deckName].cards;
                    currentCard = 0;
                    updateFlashcard();
                    updateQuizDefaults();
                    // Cập nhật tên bộ thẻ hiển thị
                    document.getElementById('currentDeckName').querySelector('span').textContent = deckName;

                    // Chuyển sang tab "Học"
                    $('#study-tab').tab('show');
                }

                // Hàm xóa bộ thẻ
                function deleteDeck(deckName) {
                    if (confirm(`Bạn có chắc muốn xóa bộ thẻ "${deckName}"?`)) {
                        // Loại bỏ bộ thẻ khỏi thư mục
                        const folderName = decks[deckName].category;
                        const index = folders[folderName].decks.indexOf(deckName);
                        if (index > -1) {
                            folders[folderName].decks.splice(index, 1);
                        }
                        delete decks[deckName];
                        if (currentDeck === deckName) {
                            currentDeck = null;
                            flashcards = [];
                        }
                        updateDecksList();
                        updateFoldersList();
                    }
                }

                // Hàm mở modal chỉnh sửa bộ thẻ
                function openEditDeckModal(deckName) {
                    document.getElementById('originalDeckName').value = deckName;
                    document.getElementById('editDeckName').value = deckName;

                    // Populate the folder select dropdown
                    const editSelectFolder = document.getElementById('editSelectFolder');
                    editSelectFolder.innerHTML = '';
                    Object.keys(folders).forEach(folderName => {
                        const selected = (folders[folderName].decks.includes(deckName)) ? 'selected' : '';
                        editSelectFolder.innerHTML += `<option value="${folderName}" ${selected}>${folderName}</option>`;
                    });

                    populateFlashcardsList(deckName);
                    $('#editDeckModal').modal('show');
                }

                // Sự kiện khi chỉnh sửa bộ thẻ
                document.getElementById('editDeckForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    const originalName = document.getElementById('originalDeckName').value;
                    const newName = document.getElementById('editDeckName').value.trim();
                    const newFolder = document.getElementById('editSelectFolder').value;

                    if (newName && newName !== originalName) {
                        if (decks[newName]) {
                            showNotification('Tên bộ thẻ đã được sử dụng.', 'info');
                            return;
                        }
                        decks[newName] = decks[originalName];
                        delete decks[originalName];
                        // Cập nhật tên bộ thẻ trong thư mục
                        const oldFolderName = decks[newName].category;
                        const folder = folders[oldFolderName];
                        const deckIndex = folder.decks.indexOf(originalName);
                        if (deckIndex > -1) {
                            folder.decks[deckIndex] = newName;
                        }
                        // Cập nhật currentDeck nếu cần
                        if (currentDeck === originalName) {
                            currentDeck = newName;
                            // Cập nhật tên bộ thẻ hiển thị
                            document.getElementById('currentDeckName').querySelector('span').textContent = newName;
                        }
                        updateDecksList();
                        updateFoldersList();
                        updateFolderOptions();
                    }

                    // Chuyển bộ thẻ sang thư mục mới nếu cần
                    const currentDeckCategory = decks[newName].category;
                    if (newFolder !== currentDeckCategory) {
                        // Loại bỏ bộ thẻ khỏi thư mục cũ
                        const oldFolder = folders[currentDeckCategory];
                        const index = oldFolder.decks.indexOf(newName);
                        if (index > -1) {
                            oldFolder.decks.splice(index, 1);
                        }

                        // Thêm bộ thẻ vào thư mục mới
                        if (!folders[newFolder]) {
                            folders[newFolder] = { decks: [] };
                        }
                        folders[newFolder].decks.push(newName);

                        // Cập nhật category của bộ thẻ
                        decks[newName].category = newFolder;
                    }

                    updateDecksList();
                    updateFoldersList();
                    updateFolderOptions();
                    $('#editDeckModal').modal('hide');
                });

                // Sự kiện khi nhấn nút "Move Deck"
                document.getElementById('moveDeckBtn').addEventListener('click', function () {
                    const deckName = document.getElementById('editDeckName').value.trim();
                    const newFolder = document.getElementById('editSelectFolder').value;

                    if (!deckName || !decks[deckName]) {
                        showNotification('Không tìm thấy bộ thẻ để chuyển.', 'info');
                        return;
                    }

                    const currentFolder = decks[deckName].category;
                    if (currentFolder === newFolder) {
                        showNotification('Bộ thẻ đã thuộc thư mục này.', 'info');
                        return;
                    }

                    // Remove deck from old folder
                    const oldFolder = folders[currentFolder];
                    const deckIndex = oldFolder.decks.indexOf(deckName);
                    if (deckIndex > -1) {
                        oldFolder.decks.splice(deckIndex, 1);
                    }

                    // Add deck to new folder
                    if (!folders[newFolder]) {
                        folders[newFolder] = { decks: [] };
                    }
                    folders[newFolder].decks.push(deckName);

                    // Update deck's category
                    decks[deckName].category = newFolder;

                    // Update UI
                    updateDecksList();
                    updateFoldersList();
                    updateFolderOptions();

                    showNotification(`Bộ thẻ "${deckName}" đã được chuyển sang thư mục "${newFolder}".`, 'info');
                });

                // Hàm xử lý nhập tệp JSON
                document.getElementById("importJsonBtn").addEventListener("click", function () {
                    const fileInput = document.getElementById("jsonFileInput");
                    const file = fileInput.files[0];

                    if (!file) {
                        alert("Vui lòng chọn một tệp JSON!");
                        return;
                    }

                    const reader = new FileReader();

                    reader.onload = function (e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (!Array.isArray(data)) {
                                alert("Tệp JSON không đúng định dạng! Cần là một mảng flashcards.");
                                return;
                            }

                            if (!currentDeck) {
                                alert("Vui lòng chọn hoặc tạo một bộ thẻ trước khi nhập JSON!");
                                return;
                            }

                            const currentDeckData = decks[currentDeck];

                            // Lưu số lượng thẻ trước khi nhập
                            const initialCount = currentDeckData.cards.length;

                            data.forEach(card => {
                                const term = card.term?.trim() || "Không có thuật ngữ";
                                const definition = card.definition?.trim() || "Không có định nghĩa";
                                const imageUrl = validateImageUrl(card.imageUrl) ? card.imageUrl : null;

                                currentDeckData.cards.push({ term, definition, imageUrl });
                            });

                            // Lưu vào localStorage
                            localStorage.setItem("flashcardData", JSON.stringify({ decks, folders }));

                            showNotification(`Đã thêm ${data.length} flashcards vào bộ thẻ "${currentDeck}"`, 'info');

                            // Cập nhật danh sách thẻ trên giao diện
                            updateDecksList();
                            displayFlashcard(initialCount); // Hiển thị thẻ đầu tiên trong danh sách mới

                        } catch (err) {
                            alert("Đã xảy ra lỗi khi đọc tệp JSON: " + err.message);
                            console.error("Lỗi phân tích JSON:", err);
                        }
                    };

                    reader.readAsText(file);
                });

                // Kiểm tra URL có hợp lệ hay không
                function validateImageUrl(url) {
                    return typeof url === "string" && (url.startsWith("http://") || url.startsWith("https://"));
                }

                // Hiển thị flashcard mới nhập
                function displayFlashcard(index = 0) {
                    const flashcards = decks[currentDeck].cards;
                    if (!flashcards.length) return;

                    const flashcard = flashcards[index];

                    document.getElementById("termDisplay").textContent = flashcard.term;
                    document.getElementById("definitionDisplay").textContent = flashcard.definition;

                    const imgElement = document.getElementById("imageDisplay");
                    if (flashcard.imageUrl) {
                        imgElement.src = flashcard.imageUrl;
                        imgElement.classList.remove("d-none");
                    } else {
                        imgElement.classList.add("d-none");
                    }
                }


                // =================== Export and Copy Deck ===================

                // Sự kiện khi nhấn nút "Export Deck"
                document.getElementById('exportDeckBtn').addEventListener('click', function () {
                    const deckName = document.getElementById('editDeckName').value.trim();
                    if (!deckName || !decks[deckName]) {
                        alert('Không tìm thấy bộ thẻ để xuất.');
                        return;
                    }
                    exportDeckToWord(deckName);
                });

                // Sự kiện khi nhấn nút "Copy Deck"
                document.getElementById('copyDeckBtn').addEventListener('click', function () {
                    const deckName = document.getElementById('editDeckName').value.trim();
                    if (!deckName || !decks[deckName]) {
                        alert('Không tìm thấy bộ thẻ để copy.');
                        return;
                    }
                    copyDeckToClipboard(deckName);
                });

                // Hàm xuất bộ thẻ ra file Word
                function exportDeckToWord(deckName) {
                    const deck = decks[deckName];
                    const doc = new docx.Document({
                        sections: [{
                            properties: {},
                            children: [
                                new docx.Paragraph({
                                    text: `Bộ thẻ: ${deckName}`,
                                    heading: docx.HeadingLevel.HEADING_1
                                }),
                                new docx.Paragraph({
                                    text: `Tạo ngày: ${new Date(deck.createDate).toLocaleDateString()}`,
                                    spacing: { after: 200 }
                                })
                            ]
                        }]
                    });

                    deck.cards.forEach((card, index) => {
                        doc.addSection({
                            properties: {},
                            children: [
                                new docx.Paragraph({
                                    text: `Thẻ ${index + 1}:`,
                                    heading: docx.HeadingLevel.HEADING_2
                                }),
                                new docx.Paragraph({
                                    text: `Thuật ngữ: ${card.term}`,
                                    spacing: { after: 100 }
                                }),
                                // Thêm hình ảnh thuật ngữ nếu có
                                ...(card.termImage ? [
                                    new docx.Paragraph({
                                        children: [
                                            new docx.ImageRun({
                                                data: base64ToUint8Array(card.termImage.split(',')[1]),
                                                transformation: {
                                                    width: 100,
                                                    height: 100,
                                                },
                                            }),
                                        ],
                                    })
                                ] : []),
                                new docx.Paragraph({
                                    text: `Định nghĩa: ${card.definition}`,
                                    spacing: { after: 100 }
                                }),
                                // Thêm hình ảnh định nghĩa nếu có
                                ...(card.definitionImage ? [
                                    new docx.Paragraph({
                                        children: [
                                            new docx.ImageRun({
                                                data: base64ToUint8Array(card.definitionImage.split(',')[1]),
                                                transformation: {
                                                    width: 100,
                                                    height: 100,
                                                },
                                            }),
                                        ],
                                    })
                                ] : []),
                                new docx.Paragraph({
                                    text: '',
                                    spacing: { after: 200 }
                                })
                            ]
                        });
                    });

                    docx.Packer.toBlob(doc).then(blob => {
                        saveAs(blob, `${deckName}.docx`);
                    });
                }

                // Hàm chuyển đổi base64 thành Uint8Array
                function base64ToUint8Array(base64) {
                    const binaryString = window.atob(base64);
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    return bytes;
                }

                // Hàm sao chép bộ thẻ vào clipboard
                function copyDeckToClipboard(deckName) {
                    const deck = decks[deckName];
                    let textContent = `Bộ thẻ: ${deckName}\nTạo ngày: ${new Date(deck.createDate).toLocaleDateString()}\n\n`;
                    deck.cards.forEach((card, index) => {
                        textContent += `*Thuật ngữ:* ${card.term}`;
                        if (card.termImage) {
                            textContent += `Hình ảnh Thuật ngữ: [Link ảnh]\n`;
                        }
                        textContent += `*Định nghĩa:* ${card.definition}\n`;
                        if (card.definitionImage) {
                            textContent += `Hình ảnh Định nghĩa: [Link ảnh]\n`;
                        }
                        textContent += `\n`;
                    });
                    navigator.clipboard.writeText(textContent)
                        .then(() => {
                            alert('Đã copy bộ thẻ vào clipboard.');
                        })
                        .catch(err => {
                            console.error('Lỗi khi copy:', err);
                        });
                }

                // =================== Handling Flashcards ===================

                // Hàm mở modal chỉnh sửa flashcard
                function openEditFlashcardModal(index) {
                    const card = decks[currentDeck].cards[index];

                    document.getElementById('editTerm').value = card.term;
                    document.getElementById('editDefinition').value = card.definition;
                    document.getElementById('editFlashcardIndex').value = index;

                    // Ẩn hình ảnh preview cũ nếu không có
                    const termImagePreview = document.getElementById('editImagePreview');
                    const definitionImagePreview = document.getElementById('editDefinitionImagePreview');

                    if (card.termImage) {
                        termImagePreview.src = card.termImage;
                        termImagePreview.classList.remove('d-none');
                    } else {
                        termImagePreview.classList.add('d-none');
                    }

                    if (card.definitionImage) {
                        definitionImagePreview.src = card.definitionImage;
                        definitionImagePreview.classList.remove('d-none');
                    } else {
                        definitionImagePreview.classList.add('d-none');
                    }

                    // Reset input file
                    document.getElementById('editTermImage').value = '';
                    document.getElementById('editDefinitionImage').value = '';

                    // Mở modal
                    $('#editFlashcardModal').modal('show');
                }

                // Sự kiện khi lưu flashcard sau khi chỉnh sửa
                document.getElementById('saveFlashcardBtn').addEventListener('click', () => {
                    const index = parseInt(document.getElementById('editFlashcardIndex').value);
                    const term = document.getElementById('editTerm').value.trim();
                    const definition = document.getElementById('editDefinition').value.trim();
                    const termImageFile = document.getElementById('editTermImage').files[0];
                    const definitionImageFile = document.getElementById('editDefinitionImage').files[0];

                    const card = decks[currentDeck].cards[index];
                    card.term = term;
                    card.definition = definition;

                    const handleUpdate = () => {
                        saveData();
                        populateFlashcardsList(currentDeck);
                        $('#editFlashcardModal').modal('hide');
                    };

                    // Nếu có chọn ảnh mới, đọc và gán
                    if (termImageFile) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            card.termImage = e.target.result;
                            if (!definitionImageFile) handleUpdate(); // Chờ xong cái này nếu không có ảnh kia
                        };
                        reader.readAsDataURL(termImageFile);
                    }

                    if (definitionImageFile) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            card.definitionImage = e.target.result;
                            handleUpdate(); // Nếu ảnh định nghĩa xong thì gọi luôn
                        };
                        reader.readAsDataURL(definitionImageFile);
                    }

                    // Nếu không có ảnh nào, thì lưu luôn
                    if (!termImageFile && !definitionImageFile) {
                        handleUpdate();
                    }
                });


                // Hàm lưu hoặc cập nhật flashcard
                function saveOrUpdateCard(index, newCard) {
                    if (index >= decks[currentDeck].cards.length) {
                        decks[currentDeck].cards.push(newCard);
                    } else {
                        decks[currentDeck].cards[index] = newCard;
                    }
                    flashcards = decks[currentDeck].cards;
                    populateFlashcardsList(currentDeck);
                    updateFlashcard();
                    updateDecksList();
                    saveData(); // Lưu ngay lập tức
                }

                // Sự kiện khi đóng modal chỉnh sửa flashcard
                document.querySelector('.btn-secondary[data-dismiss="modal"]')?.addEventListener('click', function () {
                    $('#editFlashcardModal').modal('hide'); // Đóng modal
                });

                // Hàm cập nhật sau khi chỉnh sửa
                function updateAfterEdit() {
                    flashcards = decks[currentDeck].cards;
                    populateFlashcardsList(currentDeck);
                    updateFlashcard();
                    updateDecksList();
                    saveData(); // Lưu ngay lập tức
                    $('#editFlashcardModal').modal('hide');
                    showNotification('Flashcard đã được lưu thành công.', 'info');
                }

                // =================== Handling Adding Flashcards ===================

                // Sự kiện khi thêm flashcard mới
                document.getElementById('cardForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    if (!currentDeck) {
                        showNotification('Vui lòng chọn hoặc tạo bộ thẻ trước!', 'warning');
                        document.getElementById('decks-tab').click();
                        return;
                    }

                    const term = document.getElementById('term').value.trim();
                    const definition = document.getElementById('definition').value.trim();
                    const termImageInput = document.getElementById('termImage');
                    const definitionImageInput = document.getElementById('definitionImage');

                    if (term && definition) {
                        const card = { term, definition };

                        // Xử lý hình ảnh thuật ngữ
                        if (termImageInput.files && termImageInput.files[0]) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                card.termImage = e.target.result;
                                // Tiếp tục xử lý hình ảnh định nghĩa
                                if (definitionImageInput.files && definitionImageInput.files[0]) {
                                    const defReader = new FileReader();
                                    defReader.onload = function (e) {
                                        card.definitionImage = e.target.result;
                                        addCard(card);
                                    };
                                    defReader.readAsDataURL(definitionImageInput.files[0]);
                                } else {
                                    addCard(card);
                                }
                            };
                            reader.readAsDataURL(termImageInput.files[0]);
                        } else {
                            // Nếu không có ảnh thuật ngữ, kiểm tra xem có ảnh định nghĩa không
                            if (definitionImageInput.files && definitionImageInput.files[0]) {
                                const defReader = new FileReader();
                                defReader.onload = function (e) {
                                    card.definitionImage = e.target.result;
                                    addCard(card);
                                };
                                defReader.readAsDataURL(definitionImageInput.files[0]);
                            } else {
                                addCard(card);
                            }
                        }

                        this.reset();
                        document.getElementById('imagePreview').classList.add('d-none');
                        document.getElementById('definitionImagePreview').classList.add('d-none');
                    }
                });

                // Hàm xem trước hình ảnh khi chỉnh sửa flashcard
                document.getElementById('editTermImage').addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (ev) {
                            const preview = document.getElementById('editTermImagePreview');
                            preview.src = ev.target.result;
                            preview.classList.remove('d-none');
                        };
                        reader.readAsDataURL(file);
                    }
                });

                document.getElementById('editDefinitionImage').addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (ev) {
                            const preview = document.getElementById('editDefinitionImagePreview');
                            preview.src = ev.target.result;
                            preview.classList.remove('d-none');
                        };
                        reader.readAsDataURL(file);
                    }
                });



                // Hàm xem trước hình ảnh khi thêm flashcard
                document.getElementById('termImage').addEventListener('change', function (e) {
                    const preview = document.getElementById('imagePreview');
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            preview.src = e.target.result;
                            preview.classList.remove('d-none');
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                });

                // Hàm xem trước hình ảnh định nghĩa khi thêm flashcard
                document.getElementById('definitionImage').addEventListener('change', function (e) {
                    const preview = document.getElementById('definitionImagePreview');
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            preview.src = e.target.result;
                            preview.classList.remove('d-none');
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                });
                Sortable.create(document.getElementById('flashcardsList'), {
                    animation: 150,
                    handle: '.drag-handle',
                    onEnd: function (evt) {
                        const oldIndex = evt.oldIndex;
                        const newIndex = evt.newIndex;

                        const movedCard = decks[currentDeck].cards.splice(oldIndex, 1)[0];
                        decks[currentDeck].cards.splice(newIndex, 0, movedCard);

                        flashcards = decks[currentDeck].cards;
                        saveData();

                        // ✅ Cập nhật lại UI với chỉ số mới
                        populateFlashcardsList(currentDeck);
                    }
                });



                // =================== Bulk Import ===================

                // Sự kiện khi nhấn nút "Bulk Import"
                document.getElementById('importBtn').addEventListener('click', function () {
                    if (!currentDeck) {
                        showNotification('Vui lòng chọn hoặc tạo bộ thẻ trước!', 'warning');
                        document.getElementById('decks-tab').click();
                        return;
                    }

                    const input = document.getElementById('bulkInput').value;
                    const termSep = document.getElementById('termSeparator').value;
                    const cardSep = document.getElementById('cardSeparator').value;

                    // Tách thẻ bằng xuống dòng thực sự — không động đến \n trong nội dung
                    const cards = input.split(cardSep === "\\n" ? /\r?\n/ : cardSep).filter(line => line.trim());

                    let addedCount = 0;
                    cards.forEach(cardText => {
                        const [term, ...definitionParts] = cardText.split(termSep);
                        const definition = definitionParts.join(termSep);
                        if (term && definition) {
                            addCard({
                                term: term.trim(),
                                definition: definition.trim()
                            });
                            addedCount++;
                        }
                    });

                    document.getElementById('bulkInput').value = '';
                    showNotification(`Đã thêm ${addedCount} thẻ vào bộ "${currentDeck}"`, 'info');
                });

                // Hàm thêm flashcard mới
                function addCard(card) {
                    decks[currentDeck].cards.push(card);
                    flashcards = decks[currentDeck].cards;
                    updateFlashcard();
                    updateDecksList();
                    updateFoldersList();
                    saveData(); // Lưu ngay lập tức
                    showNotification('Thêm flashcard thành công!', 'success');
                }

                // =================== Flashcard Display ===================
                // Hàm xử lý xem trước ảnh và lưu vào JSON
                function handleImageUpload(event, previewId, key) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            // Hiển thị ảnh xem trước
                            const imgElement = document.getElementById(previewId);
                            imgElement.src = e.target.result;  // Chuyển file thành Base64
                            imgElement.classList.remove("d-none");

                            // Lưu vào sessionStorage
                            sessionStorage.setItem(key, e.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                }

                document.getElementById("cardForm").addEventListener("submit", function (event) {
                    event.preventDefault();

                    // Lấy dữ liệu từ form
                    const term = document.getElementById("term").value.trim();
                    const definition = document.getElementById("definition").value.trim();
                    const termImage = sessionStorage.getItem("termImage") || null;
                    const definitionImage = sessionStorage.getItem("definitionImage") || null;

                    if (!term || !definition) {
                        showNotification('Vui lòng nhập đầy đủ thuật ngữ và định nghĩa!', 'warning');
                        return;
                    }

                    // Tạo flashcard mới
                    const newFlashcard = {
                        term: term,
                        definition: definition,
                        termImage: termImage,
                        definitionImage: definitionImage
                    };

                    // Lưu vào JSON (hoặc bộ thẻ hiện tại)
                    flashcards.push(newFlashcard);

                    // Xóa ảnh lưu tạm để tránh lỗi
                    sessionStorage.removeItem("termImage");
                    sessionStorage.removeItem("definitionImage");

                    // Reset form
                    document.getElementById("cardForm").reset();
                    document.getElementById("imagePreview").classList.add("d-none");
                    document.getElementById("definitionImagePreview").classList.add("d-none");

                    showNotification('Thẻ đã được thêm!', 'info');
                });

                let showTermFirst = true; // Default to show term first

                // Hàm cập nhật hiển thị flashcard dựa trên lựa chọn của người dùng
                function updateFlashcard() {
                    if (!flashcards || flashcards.length === 0) {
                        console.warn("Không có flashcard để hiển thị.");
                        return;
                    }

                    const card = flashcards[currentCard];
                    const flashcardFront = document.querySelector('.flashcard-front');
                    const flashcardBack = document.querySelector('.flashcard-back');

                    if (!flashcardFront || !flashcardBack) {
                        console.error("Không tìm thấy phần tử flashcard.");
                        return;
                    }

                    flashcardFront.innerHTML = '';
                    flashcardBack.innerHTML = '';

                    if (showTermFirst) {
                        createFlashcardSide(flashcardFront, card.term, card.termImage || card.imageUrl);
                        createFlashcardSide(flashcardBack, card.definition, card.definitionImage);
                    } else {
                        createFlashcardSide(flashcardFront, card.definition, card.definitionImage);
                        createFlashcardSide(flashcardBack, card.term, card.termImage || card.imageUrl);
                    }

                    document.getElementById('cardProgress').textContent = `${currentCard + 1}/${flashcards.length}`;
                }

                // Hàm tạo mặt thẻ (mặt trước hoặc mặt sau)
                function createFlashcardSide(container, text, imageUrl) {
                    if (!container) return;

                    // Hiển thị nội dung chữ
                    const textPre = document.createElement('pre');
                    textPre.className = 'card-text';
                    textPre.textContent = text || "Không có nội dung";
                    container.appendChild(textPre);

                    // Kiểm tra và hiển thị hình ảnh
                    if (imageUrl) {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = 'Flashcard Image';
                        img.className = 'img-fluid mt-2';



                        container.appendChild(img);
                    }
                }

                // Sự kiện khi nhấn nút "Show Term First"
                document.getElementById('showTermFirst').addEventListener('click', function () {
                    showTermFirst = true;
                    updateFlashcard();
                    this.classList.add('btn-primary');
                    this.classList.remove('btn-outline-primary');
                    document.getElementById('showDefFirst').classList.add('btn-outline-secondary');
                    document.getElementById('showDefFirst').classList.remove('btn-primary');
                    saveShowOrder();
                });

                // Sự kiện khi nhấn nút "Show Definition First"
                document.getElementById('showDefFirst').addEventListener('click', function () {
                    showTermFirst = false;
                    updateFlashcard();
                    this.classList.add('btn-primary');
                    this.classList.remove('btn-outline-secondary');
                    document.getElementById('showTermFirst').classList.add('btn-outline-primary');
                    document.getElementById('showTermFirst').classList.remove('btn-primary');
                    saveShowOrder();
                });

                // Hàm lưu thứ tự hiển thị vào localStorage
                function saveShowOrder() {
                    localStorage.setItem('showOrder', showTermFirst ? 'termFirst' : 'defFirst');
                }

                // Hàm khôi phục thứ tự hiển thị từ localStorage
                function restoreShowOrder() {
                    const savedOrder = localStorage.getItem('showOrder');
                    if (savedOrder) {
                        showTermFirst = savedOrder === 'termFirst';
                    }
                    // Cập nhật style cho các nút
                    if (showTermFirst) {
                        document.getElementById('showTermFirst').classList.add('btn-primary');
                        document.getElementById('showTermFirst').classList.remove('btn-outline-primary');
                        document.getElementById('showDefFirst').classList.add('btn-outline-secondary');
                        document.getElementById('showDefFirst').classList.remove('btn-primary');
                    } else {
                        document.getElementById('showDefFirst').classList.add('btn-primary');
                        document.getElementById('showDefFirst').classList.remove('btn-outline-secondary');
                        document.getElementById('showTermFirst').classList.add('btn-outline-primary');
                        document.getElementById('showTermFirst').classList.remove('btn-primary');
                    }
                    updateFlashcard();
                }

                // Khôi phục thứ tự hiển thị khi tải trang
                restoreShowOrder();

                // Sự kiện khi nhấn vào flashcard để lật
                document.getElementById('flashcard').addEventListener('click', function () {
                    this.classList.toggle('flipped');
                });

                // =================== Navigation Buttons ===================

                // Sự kiện khi nhấn nút "Previous"
                document.getElementById('prevCard').addEventListener('click', function () {
                    if (currentCard > 0) {
                        goToCard(currentCard - 1, 'prev');
                    }
                });


                // Sự kiện khi nhấn nút "Next"
                document.getElementById('nextCard').addEventListener('click', function () {
                    if (currentCard < flashcards.length - 1) {
                        goToCard(currentCard + 1, 'next');
                    } else {
                        triggerFireworks();
                        onUserCompletedActivity();
                        showCompletionOptions();
                    }
                });


              // =================== Speech Synthesis ===================
let isSpeaking = false;
let cancelRequested = false;

const readCountInput = document.getElementById('readCount');
const speakBtn        = document.getElementById('speakBtn');
const stopSpeakBtn    = document.getElementById('stopSpeakBtn');
const languageSelect  = document.getElementById('languageSelect');

// Thay hàm speakCurrentCard cũ bằng hàm đệ quy này:
function speakRepeated(text, lang, times, iteration = 0) {
  if (cancelRequested || iteration >= times) {
    // Kết thúc chuỗi đọc
    isSpeaking = false;
    speakBtn.classList.remove('d-none');
    stopSpeakBtn.classList.add('d-none');
    return;
  }

  const utter = new SpeechSynthesisUtterance(text);
  if (lang !== 'none') utter.lang = lang;

  utter.onstart = () => {
    isSpeaking = true;
    speakBtn.classList.add('d-none');
    stopSpeakBtn.classList.remove('d-none');
  };
  utter.onend = () => {
    // Đọc xong một lượt, tiếp nếu chưa đủ
    speakRepeated(text, lang, times, iteration + 1);
  };
  utter.onerror = () => {
    // Nếu lỗi, vẫn cố gắng tiếp
    speakRepeated(text, lang, times, iteration + 1);
  };

  window.speechSynthesis.speak(utter);
}

// Khi bấm “Speak”
speakBtn.addEventListener('click', () => {
  const card = flashcards[currentCard];
  // Lấy text tùy flipped hay không
  const text = document.getElementById('flashcard').classList.contains('flipped')
               ? card.definition
               : card.term;

  const lang  = languageSelect.value;
  if (lang === 'none') return;

  const times = Math.max(1, parseInt(readCountInput.value, 10) || 1);
  cancelRequested = false;
  speakRepeated(text, lang, times);
});

// Khi bấm “Stop”
stopSpeakBtn.addEventListener('click', () => {
  cancelRequested = true;
  window.speechSynthesis.cancel();
  // will be hidden by speakRepeated on next check
});
// Thay thế hoàn toàn hàm speakCurrentCard hiện tại bằng:
function speakCurrentCard() {
    // Lấy thẻ và text cần đọc
    const card = flashcards[currentCard];
    const flipped = document.getElementById('flashcard').classList.contains('flipped');
    const text = flipped ? card.definition : card.term;

    // Ngôn ngữ
    const lang = languageSelect.value;
    if (lang === 'none') return;

    // Số lần đọc
    const times = Math.max(1, parseInt(readCountInput.value, 10) || 1);

    // Reset flag và gọi hàm đệ quy
    cancelRequested = false;
    speakRepeated(text, lang, times);
}


                // Sửa lại sự kiện chuyển thẻ (cập nhật thẻ và tự động đọc)
                function goToCard(nextIndex, direction) {
                    const flashcardEl = document.getElementById('flashcard');
                    const outClass = direction === 'next' ? 'slide-out-left' : 'slide-out-right';
                    const inClass = direction === 'next' ? 'slide-in-right' : 'slide-in-left';

                    flashcardEl.classList.add(outClass);

                    setTimeout(() => {
                        currentCard = nextIndex;
                        updateFlashcard();
                        flashcardEl.classList.remove('flipped');
                        flashcardEl.classList.remove(outClass);
                        flashcardEl.classList.add(inClass);

                        setTimeout(() => {
                            flashcardEl.classList.remove(inClass);
                            speakCurrentCard();  // Tự động đọc thẻ khi chuyển sang thẻ mới
                        }, 100); // Thời gian cho animation
                    }, 400);
                }

                // =================== Autoplay Functionality ===================


                // Sự kiện khi nhấn nút "Autoplay"
                // Sự kiện khi nhấn nút "Autoplay"
                document.getElementById('autoPlayBtn').addEventListener('click', function () {
                    if (autoPlayInterval) {
                        clearInterval(autoPlayInterval);
                        autoPlayInterval = null;

                        this.innerHTML = '<i class="fas fa-play"></i>';
                    } else {
                        const speed = document.getElementById('speedRange').value * 1900;

                        autoPlayInterval = setInterval(() => {
                            const cardEl = document.getElementById('flashcard');
                            // 1. Flip lên
                            cardEl.classList.add('flipped');

                            // 2. Sau nửa thời gian, unflip và slide
                            setTimeout(() => {
                                cardEl.classList.remove('flipped');

                                // Tính nextIndex (vòng về 0 nếu cuối mảng)
                                const nextIndex = (currentCard < flashcards.length - 1)
                                    ? currentCard + 1
                                    : 0;

                                // Dùng hiệu ứng slide
                                goToCard(nextIndex, 'next');
                            }, speed / 2);

                        }, speed);

                        this.innerHTML = '<i class="fas fa-pause"></i>';
                    }
                });


                // Sự kiện khi điều chỉnh tốc độ autoplay
                document.getElementById('speedRange').addEventListener('input', function () {
                    document.getElementById('speedValue').textContent = this.value;
                    if (autoPlayInterval) {
                        clearInterval(autoPlayInterval);
                        const speed = this.value * 1900;
                        autoPlayInterval = setInterval(() => {
                            const cardEl = document.getElementById('flashcard');
                            cardEl.classList.add('flipped');
                            setTimeout(() => {
                                cardEl.classList.remove('flipped');
                                const nextIndex = (currentCard < flashcards.length - 1)
                                    ? currentCard + 1
                                    : 0;
                                goToCard(nextIndex, 'next');
                            }, speed / 2);
                        }, speed);
                    }
                });



                document.getElementById('fullscreenBtn').addEventListener('click', function () {
                    const studySection = document.querySelector('#study');
                    const icon = this.querySelector('i');

                    if (!document.fullscreenElement) {
                        studySection.requestFullscreen();
                        studySection.classList.add('fullscreen-mode');
                        icon.classList.remove('fa-expand');
                        icon.classList.add('fa-compress');
                    } else {
                        document.exitFullscreen();
                        studySection.classList.remove('fullscreen-mode');
                        icon.classList.remove('fa-compress');
                        icon.classList.add('fa-expand');
                    }
                });



                // =================== Quiz Functionality ===================


                // Gán sự kiện cho nút
                document.getElementById('startQuiz').onclick = () => {
                    buildQuizQuestions();
                    currentQuestion = 0;
                    score = 0;
                    quizResults = { correct: [], incorrect: [] };
                    document.getElementById('submitQuiz').classList.remove('d-none');
                    document.getElementById('skipQuestion').classList.remove('d-none');
                    showQuestion();
                };

                document.getElementById('shuffleQuiz').addEventListener('click', function () {
                    quizQuestions = shuffleArray([...quizQuestions]).map((q, index) => ({
                        ...q,
                        number: index + 1
                    }));
                    showQuestion();
                });

                document.getElementById('submitQuiz').addEventListener('click', submitQuiz);
                document.getElementById('skipQuestion').addEventListener('click', skipQuestion);
                document.addEventListener('DOMContentLoaded', function () {
                    document.getElementById('skipQuestion').classList.add('d-none');
                });

                // Hàm bắt đầu quiz
                function startQuiz() {
                    if (!currentDeck || flashcards.length === 0) {
                        showNotification('Vui lòng chọn bộ thẻ có flashcard trước!', 'warning');
                        return;
                    }

                    const count = parseInt(document.getElementById('questionCount').value, 10);
                    const startFrom = parseInt(document.getElementById('startFrom').value, 10);
                    const endAt = parseInt(document.getElementById('endAt').value, 10);
                    const isMC = document.getElementById('multipleChoice').checked;
                    const isTermToDef = document.getElementById('termTodef').checked;


                    // Kiểm tra hợp lệ
                    if (
                        isNaN(count) || count <= 0 ||
                        startFrom < 1 || endAt < 1 ||
                        startFrom > flashcards.length || endAt > flashcards.length
                    ) {
                        showNotification(`Vui lòng nhập khoảng câu hợp lệ từ 1 đến ${flashcards.length}`, 'warning');
                        return;
                    }
                    if (startFrom - endAt > flashcards.length) {
                        showNotification('Số câu chọn vượt quá số lượng trong bộ thẻ', 'warning');
                        return;
                    }

                    let selectedFlashcards;
                    if (startFrom <= endAt) {
                        selectedFlashcards = flashcards.slice(startFrom - 1, endAt);
                    } else {
                        selectedFlashcards = flashcards.slice(endAt - 1, startFrom).reverse();
                    }

                    if (selectedFlashcards.length === 0) {
                        showNotification('Không có flashcard nào trong khoảng đã chọn!', 'info');
                        return;
                    }


                    // Nếu count > số flashcards, lặp lại
                    let pool = [];
                    while (pool.length < count) {
                        pool = pool.concat(selectedFlashcards);
                    }
                    const finalList = pool.slice(0, count);



                    quizQuestions = finalList.map((card, index) => {
                        const rawAns = isTermToDef ? card.definition : card.term;
                        const parts = rawAns.split(',').map(s => s.trim());
                        const multiAns = isMC && parts.length > 1 && parts.every(p => /^[A-Za-z]$/.test(p));
                        const answers = multiAns ? parts : [rawAns.trim()];

                        return {
                            number: index + 1,
                            question: isTermToDef ? card.term : card.definition,
                            answers,
                            isMultipleChoice: isMC,
                            options: isMC ? generateOptionsForCard(card, isTermToDef, answers) : [],
                            userAnswer: isMC ? [] : null,
                            isCorrect: false,
                            answered: false,
                            sourceCard: card
                        };
                    });

                    currentQuestion = 0;
                    score = 0;
                    quizResults = { correct: [], incorrect: [] };

                    showQuestion();
                    document.getElementById('submitQuiz').classList.remove('d-none');
                    document.getElementById('skipQuestion').classList.remove('d-none');
                }


                // Hàm bỏ qua câu hỏi hiện tại
                function skipQuestion() {
                    const question = quizQuestions[currentQuestion];
                    question.isCorrect = false;
                    question.answered = true;
                    quizResults.incorrect.push({
                        question: question.question,
                        yourAnswer: 'Bỏ qua',
                        correctAnswer: question.answers.join(', '),
                        image: question.image || null
                    });
                    nextQuestion();
                }

                // Hàm xóa câu hỏi hiện tại và chuyển sang câu tiếp theo
                function nextQuestion() {
                    currentQuestion++;
                    showQuestion();
                }

                // Hàm hỗ trợ xáo trộn mảng (Fisher-Yates)
                function shuffleArray(array) {
                    let currentIndex = array.length, randomIndex;

                    // While there remain elements to shuffle
                    while (currentIndex !== 0) {

                        // Pick a remaining element
                        randomIndex = Math.floor(Math.random() * currentIndex);
                        currentIndex--;

                        // And swap it with the current element
                        [array[currentIndex], array[randomIndex]] = [
                            array[randomIndex], array[currentIndex]];
                    }

                    return array;
                }

                function buildQuizQuestions() {
                    // 1. Đọc input
                    const startFrom = parseInt(document.getElementById('startFrom').value, 10);
                    const endAt = parseInt(document.getElementById('endAt').value, 10);
                    const desiredCount = parseInt(document.getElementById('questionCount').value, 10);
                    const isTermToDef = document.getElementById('termTodef').checked;
                    const isMC = document.getElementById('multipleChoice').checked;
                    if (startFrom - endAt > flashcards.length) {
                        showNotification('Số câu chọn vượt quá số lượng trong bộ thẻ', 'warning');
                        return;
                    }
                    // 2. Tính chỉ số slice
                    const sIdx = startFrom - 1;
                    const eIdx = endAt; // slice không bao gồm eIdx

                    // 3. Lấy subset, đảo ngược nếu cần
                    let subset;
                    if (startFrom <= endAt) {
                        subset = flashcards.slice(sIdx, eIdx);
                    } else {
                        subset = flashcards.slice(endAt - 1, startFrom).reverse();
                    }

                    // 4. Nếu subset rỗng thì dừng
                    if (subset.length === 0) {
                        showNotification('Không có flashcard nào trong khoảng đã chọn!', 'info');
                        return;
                    }

                    // 5. Tạo pool, lặp lại nếu desiredCount > subset.length
                    let pool = [];
                    if (desiredCount > subset.length) {
                        while (pool.length < desiredCount) {
                            pool = pool.concat(subset);
                        }
                        pool = pool.slice(0, desiredCount);
                    } else {
                        pool = subset.slice(0, desiredCount);
                    }

                    // 6. Map thành quizQuestions
                    quizQuestions = pool.map((card, idx) => {
                        // Câu hỏi và đáp án
                        const questionText = isTermToDef ? card.term : card.definition;
                        const rawAns = isTermToDef ? card.definition : card.term;

                        // Tách multiple single-letter answers (A, B, C…)
                        const parts = rawAns.split(',').map(p => p.trim());
                        const multiSingleLetters = isMC && parts.length > 1 && parts.every(p => /^[A-Za-z]$/.test(p));
                        const answers = multiSingleLetters ? parts : [rawAns.trim()];

                        return {
                            number: idx + 1,
                            question: questionText,
                            answers,
                            isMultipleChoice: isMC,
                            options: isMC
                                ? generateOptionsForCard(card, isTermToDef, answers)
                                : [],
                            correctAnswer: rawAns.trim(),
                            sourceCard: card
                        };
                    });
                }



                // Ví dụ hàm generateOptionsForCard vẫn dùng như trước
                function generateOptionsForCard(correctCard, isTermToDef, answers) {
                    const otherCards = flashcards.filter(c => c !== correctCard);
                    let opts = [...answers]; // đúng hơn là từ answers thay vì tách lại từ rawAns

                    while (opts.length < 4 && otherCards.length) {
                        const idx = Math.floor(Math.random() * otherCards.length);
                        const pickRaw = isTermToDef
                            ? otherCards[idx].definition
                            : otherCards[idx].term;
                        const pick = pickRaw.split(',')[0].trim(); // chỉ lấy 1 phương án

                        if (!opts.includes(pick)) opts.push(pick);
                        otherCards.splice(idx, 1);
                    }

                    return shuffleArray(opts);
                }

                function escapeHTML(text) {
                    return text
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;");
                }

                function normalizeText(text) {
                    return text
                        .replace(/\s+/g, ' ')
                        .trim();
                }
              function showQuestion() {
  const qc = document.getElementById('quizContent');
  document.getElementById('quizResults').innerHTML = '';

  if (currentQuestion >= quizQuestions.length) {
    showQuizResults();
    return;
  }

  const q = quizQuestions[currentQuestion];
  const qNum = currentQuestion + 1;
  const byTerm = document.getElementById('termTodef').checked;
  const isAudio = document.getElementById('audioQuiz').checked;

  const cardData = flashcards.find(card =>
    byTerm ? card.term === q.question : card.definition === q.question
  ) || {};

  const termImg = cardData.termImage ? `<img src="${cardData.termImage}" class="img-fluid mb-2">` : '';
  const defImg = cardData.definitionImage ? `<img src="${cardData.definitionImage}" class="img-fluid mb-2">` : '';

  let doPlay, utter;
  if (isAudio) {
    const voiceName = document.getElementById('quizLanguage').value;
    const voice = availableVoices.find(v => v.name === voiceName);
    utter = new SpeechSynthesisUtterance(q.question);
    if (voice) { utter.voice = voice; utter.lang = voice.lang; }
    doPlay = () => {
      const rate = parseFloat(document.getElementById('audioSpeed').value);
      utter.rate = rate;
      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    };
  }

  const isShort = q.question.trim().split(/\s+/).length <= 10;
  const questionStyle = isAudio
    ? 'color: transparent;'
    : (isShort ? 'font-size:2rem;' : 'font-weight:200;');

  // Format câu hỏi xuống dòng
  const formattedQuestion = escapeHTML(q.question).replace(/\n/g, '<br>');

  let ansHTML = '';
  if (!q.isMultipleChoice) {
    ansHTML = `
      <div class="form-group">
        <input type="text" id="writtenAnswerInput" class="form-control" placeholder="Nhập câu trả lời">
      </div>
      <button class="btn btn-primary" id="submitWritten">Kiểm tra</button>
    `;
  } else if (q.answers.length > 1) {
    ansHTML = `
      <form id="multiForm">
        ${q.options.map((opt, i) => `
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="opt${i}" value="${escapeHTML(opt)}">
            <label class="form-check-label" for="opt${i}">
              <strong>${String.fromCharCode(65 + i)}.</strong> ${escapeHTML(opt)}
            </label>
          </div>
        `).join('')}
        <button type="button" class="btn btn-primary mt-3" id="submitMulti">Submit</button>
        <div id="multiFeedback" class="mt-2"></div>
      </form>
    `;
  } else {
    ansHTML = `
      <div id="optionsContainer">
        ${q.options.map((opt, i) => `
          <button class="btn btn-outline-secondary btn-block mb-2 quiz-option"
                  data-opt="${escapeHTML(opt)}">
            <strong>${String.fromCharCode(65 + i)}.&nbsp;&nbsp;&nbsp;</strong> ${escapeHTML(opt)}
          </button>
        `).join('')}
      </div>
    `;
  }

  // Render nội dung
  qc.innerHTML = `
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">
          Câu ${qNum}/${quizQuestions.length}${isAudio ? ' (Audio quiz)' : ''}
        </h5>

        ${isAudio ? `
          <div class="text-center mb-3">
            <button id="playBtn"   class="btn btn-primary mr-2">▶️ Phát</button>
            <button id="replayBtn" class="btn btn-secondary mr-2">🔁 Lặp</button>
            <button id="stopBtn"   class="btn btn-danger mr-2">⏹️ Dừng</button>
            <label class="ml-2">Tốc độ:</label>
            <input type="range" id="audioSpeed" min="0.5" max="2" step="0.1" value="1"
                   style="width:120px;vertical-align:middle">
            <span id="speedLabel">1.0×</span>
          </div>` : ''}

        <div class="mb-2 question-text" style="margin:0;padding:0;line-height:1.5;${questionStyle}">
          ${formattedQuestion}
        </div>

        ${termImg}${defImg}
        <hr class="my-3">
        ${ansHTML}
      </div>
    </div>
  `;

  const questionEl = qc.querySelector('.question-text');
  const wordCount = q.question.trim().split(/\s+/).length;
  questionEl.classList.remove('question-big', 'question-small');

  if (window.innerWidth <= 575.98) {
    questionEl.classList.add(wordCount > 5 ? 'question-small' : 'question-big');
  }

  // Audio binding
  if (isAudio) {
    setTimeout(() => {
      document.getElementById('playBtn').onclick = doPlay;
      document.getElementById('replayBtn').onclick = doPlay;
      document.getElementById('stopBtn').onclick = () => speechSynthesis.cancel();
      const speedInput = document.getElementById('audioSpeed');
      const speedLabel = document.getElementById('speedLabel');
      speedInput.oninput = () => {
        speedLabel.textContent = speedInput.value + '×';
        if (speechSynthesis.speaking) {
          speechSynthesis.cancel();
          utter.rate = parseFloat(speedInput.value);
          speechSynthesis.speak(utter);
        }
      };
      doPlay();
    }, 0);
  }

  // Handle input/check/submit
  if (!q.isMultipleChoice) {
    document.getElementById('submitWritten').onclick = () => checkWrittenAnswer();
  } else if (q.answers.length > 1) {
    document.getElementById('submitMulti').onclick = () => {
      const feedbackEl = document.getElementById('multiFeedback');
      const checked = Array.from(
        document.querySelectorAll('#multiForm .form-check-input:checked')
      ).map(cb => cb.value.trim().toLowerCase());
      const correct = q.answers.map(a => a.trim().toLowerCase());
      if (arraysEqualAsSets(checked, correct)) {
        feedbackEl.className = 'mt-2 text-success';
        feedbackEl.innerText = 'Chính xác!';
        correctSound.play?.().catch(console.error);
        setTimeout(() => nextQuestion(), 800);
      } else {
        feedbackEl.className = 'mt-2 text-danger';
        feedbackEl.innerText = 'Sai! Hãy chọn lại lần nữa.';
        incorrectSound.play?.().catch(console.error);
      }
    };
  } else {
    document.querySelectorAll('#optionsContainer .quiz-option').forEach(btn => {
      btn.onclick = () => handleOptionClick(btn, btn.getAttribute('data-opt'));
    });
  }

  if (!q.isMultipleChoice) {
    setTimeout(() => {
      document.getElementById('writtenAnswerInput')?.focus();
    }, 0);
  }
}


                // So sánh two sets
                function arraysEqualAsSets(a, b) {
                    if (a.length !== b.length) return false;
                    const sa = new Set(a), sb = new Set(b);
                    if (sa.size !== sb.size) return false;
                    for (let x of sa) if (!sb.has(x)) return false;
                    return true;
                }



                function setAudioSpeed(speed) {
                    const audio = document.getElementById('questionAudio');
                    if (audio) audio.playbackRate = parseFloat(speed);
                }




                document.addEventListener("keydown", function (event) {
                    if (event.key === "Enter") {
                        event.preventDefault(); // Ngăn trình duyệt thực hiện hành động mặc định (nếu có)
                        checkWrittenAnswer(); // Gọi hàm kiểm tra
                    }
                });


                // Hàm làm lại các câu sai
                function retryIncorrectQuestions() {
                    // Lọc ra các câu hỏi sai
                    const incorrectQuestions = quizResults.incorrect.map(item =>
                        quizQuestions.find(q => q.question === item.question)
                    );

                    // Nếu không có câu sai, thông báo cho người dùng
                    if (incorrectQuestions.length === 0) {
                        showNotification('Không có câu hỏi sai để làm lại!', 'info');
                        return;
                    }

                    // Thiết lập lại quiz với các câu sai
                    quizQuestions = incorrectQuestions;
                    currentQuestion = 0;
                    score = 0;
                    quizResults = { correct: [], incorrect: [] };

                    // Reset trạng thái mỗi câu
                    quizQuestions.forEach(question => {
                        question.answered = false;
                        question.isCorrect = false;
                        question.attempts = 0;    // **QUAN TRỌNG**: reset lượt thử
                    });

                    // Hiển thị lại câu hỏi đầu tiên
                    showQuestion();
                }






                // Hàm xử lý khi người dùng chọn đáp án trong quiz
                function handleOptionClick(button, selectedOption) {
                    const question = quizQuestions[currentQuestion];
                    if (question.answered) return;

                    // Khởi tạo attempts
                    if (typeof question.attempts === 'undefined') {
                        question.attempts = 0;
                    }

                    const correctAnswers = question.answers.map(a => a.toLowerCase());
                    const userAnswer = selectedOption.toLowerCase();

                    if (correctAnswers.includes(userAnswer)) {
                        // === Đúng ===
                        score++;
                        question.isCorrect = true;
                        question.answered = true;
                        quizResults.correct.push({
                            question: question.question,
                            yourAnswer: selectedOption,
                            correctAnswer: question.answers.join(', '),
                            image: question.image || null
                        });

                        correctSound.currentTime = 0;
                        correctSound.play().catch(console.error);

                        button.classList.add('correct');
                        button.classList.remove('btn-outline-secondary');
                        button.disabled = true;

                        // đánh dấu tất cả đáp án đúng
                        document.querySelectorAll('#optionsContainer .quiz-option').forEach(btn => {
                            const txt = btn.textContent.slice(3).trim().toLowerCase();
                            if (correctAnswers.includes(txt)) {
                                btn.classList.add('correct');
                                btn.classList.remove('btn-outline-secondary');
                                btn.disabled = true;
                            }
                        });

                        setTimeout(nextQuestion, 800);

                    } else {
                        // === Sai ===
                        question.attempts++;

                        // record incorrect lần đầu
                        if (question.attempts === 1) {
                            quizResults.incorrect.push({
                                question: question.question,
                                yourAnswer: selectedOption,
                                correctAnswer: question.answers.join(', '),
                                image: question.image || null
                            });
                        }

                        // reset và play ngay
                        incorrectSound.currentTime = 0;
                        incorrectSound.play().catch(console.error);

                        button.classList.add('incorrect');
                        button.classList.remove('btn-outline-secondary');

                        // highlight đáp án đúng
                        document.querySelectorAll('#optionsContainer .quiz-option').forEach(btn => {
                            const txt = btn.textContent.slice(3).trim().toLowerCase();
                            if (correctAnswers.includes(txt)) {
                                btn.classList.add('correct');
                                btn.classList.remove('btn-outline-secondary');
                            }
                        });

                        if (question.attempts === 1) {
                            // shake lần đầu
                            button.classList.add('shake');
                            // remove shake sau 500ms
                            setTimeout(() => {
                                button.classList.remove('shake');
                                const inputField = document.getElementById('writtenAnswerInput');
                                if (inputField) {
                                    inputField.focus();
                                    inputField.select();
                                }
                            }, 500);
                        }
                        // Lần 2 trở đi không shake, chỉ chờ user click lại
                    }
                }



                // Hàm tính độ tương đồng giữa hai chuỗi
                function calculateSimilarity(str1, str2) {
                    const track = Array(str2.length + 1).fill(null).map(() =>
                        Array(str1.length + 1).fill(null));

                    for (let i = 0; i <= str1.length; i++) track[0][i] = i;
                    for (let j = 0; j <= str2.length; j++) track[j][0] = j;

                    for (let j = 1; j <= str2.length; j++) {
                        for (let i = 1; i <= str1.length; i++) {
                            const indicator = str1[i - 1] === str2[j - 1] ? 0 : 1;
                            track[j][i] = Math.min(
                                track[j][i - 1] + 1,    // Deletion
                                track[j - 1][i] + 1,    // Insertion
                                track[j - 1][i - 1] + indicator // Substitution
                            );
                        }
                    }

                    const distance = track[str2.length][str1.length];
                    const maxLength = Math.max(str1.length, str2.length);
                    return maxLength === 0 ? 1 : (1 - distance / maxLength);
                }

                // Hàm kiểm tra câu trả lời tự luận
                function checkWrittenAnswer() {
                    const inputEl = document.getElementById('writtenAnswerInput');
                    const userRaw = inputEl.value.trim();

                    const oldFb = document.getElementById('writtenFeedback');
                    if (oldFb) oldFb.remove();

                    if (!userRaw) {
                        inputEl.insertAdjacentHTML('afterend', `
      <div id="writtenFeedback" class="text-danger mt-2">
        Vui lòng nhập đáp án.
      </div>
    `);
                        return;
                    }

                    const normalize = text => text
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .replace(/[^\w\s\u3040-\u30FF\u4E00-\u9FFF]/gu, '')
                        .replace(/\s+/g, ' ')
                        .trim()
                        .toLowerCase();

                    const q = quizQuestions[currentQuestion];
                    const userNorm = normalize(userRaw);
                    let isCorrect = false;

                    if (q.answers.length > 1) {
                        const userSet = userRaw.split(',').map(a => normalize(a)).filter(a => a);
                        const correctSet = q.answers.map(a => normalize(a));
                        isCorrect = arraysEqualAsSets(userSet, correctSet);
                    } else {
                        const sims = q.answers.map(a => calculateSimilarity(userNorm, normalize(a)));
                        isCorrect = Math.max(...sims) >= 0.8;
                    }

                    q.userAnswer = userRaw;
                    q.answered = true;
                    q.isCorrect = isCorrect;

                    if (isCorrect) {
                        inputEl.insertAdjacentHTML('afterend', `
      <div id="writtenFeedback" class="text-success mt-2">
        <strong>✅ Chính xác!</strong>
      </div>
    `);
                        score++;
                        quizResults.correct.push({
                            question: q.question,
                            yourAnswer: userRaw,
                            correctAnswer: q.answers.join(', '),
                            image: q.image || null
                        });
                        correctSound?.play?.().catch(console.error);
                        setTimeout(() => nextQuestion(), 500);
                    } else {
                        inputEl.insertAdjacentHTML('afterend', `
      <div id="writtenFeedback" class="text-danger mt-2">
        <strong>❌ Chưa chính xác.</strong>
        <button id="revealAnswer" class="btn btn-link btn-sm p-0 ml-2">Hiện đáp án</button>
        <div id="correctAnswer" class="mt-1" style="display:none;">
          Đáp án đúng: ${escapeHTML(q.answers.join(', '))}
        </div>
      </div>
    `);
                        quizResults.incorrect.push({
                            question: q.question,
                            yourAnswer: userRaw,
                            correctAnswer: q.answers.join(', '),
                            image: q.image || null
                        });
                        incorrectSound?.play?.().catch(console.error);
                        inputEl.focus();
                        inputEl.select();

                        const revealBtn = document.getElementById('revealAnswer');
                        revealBtn.onclick = () => {
                            const ca = document.getElementById('correctAnswer');
                            ca.style.display = ca.style.display === 'none' ? 'block' : 'none';
                        };

                        if (!window.__revealCtrlListenerAttached) {
                            document.addEventListener('keydown', function (e) {
                                if (e.ctrlKey && !e.shiftKey && !e.altKey) {
                                    const ca = document.getElementById('correctAnswer');
                                    if (ca) {
                                        e.preventDefault();
                                        ca.style.display = ca.style.display === 'none' ? 'block' : 'none';
                                    }
                                }
                            });
                            window.__revealCtrlListenerAttached = true;
                        }
                    }
                }




                // Hàm hiển thị kết quả quiz
                function showQuizResults() {
                    onUserCompletedActivity();
                    const quizContent = document.getElementById('quizContent');
                    const quizResultsDiv = document.getElementById('quizResults');
                    quizContent.innerHTML = ''; // Xóa nội dung câu hỏi

                    const percentage = Math.round(score / quizQuestions.length * 100);
                    quizResultsDiv.innerHTML = `
            <div class="alert alert-success">
                <h4 class="alert-heading">Hoàn thành!</h4>
                <p>Điểm số của bạn: ${score}/${quizQuestions.length} (${percentage}%)</p>
                <hr>
                <p class="mb-0">Tỉ lệ đúng: ${percentage}%</p>
            </div>
        `;
                    quizResultsDiv.innerHTML += `
    <div class="mt-4">
        <button class="btn btn-warning mr-2" onclick="retryIncorrectQuestions()">Làm lại câu sai</button>
    </div>
`;

                    // Nếu đạt 100%, kích hoạt pháo hoa
                    if (percentage === 100) {
                        triggerFireworks();
                    }

                    // Hiển thị danh sách câu đúng
                    if (quizResults.correct.length > 0) {
                        const correctList = quizResults.correct.map(item => `
                <li>
                    <strong>Câu hỏi:</strong> ${item.question}<br>
                    ${item.image ? `<img src="${item.image}" alt="Question Image" class="img-fluid mb-2" style="max-width: 200px;">` : ''}
                    <strong>Đáp án của bạn:</strong> ${item.yourAnswer}<br>
                    <strong>Đáp án chuẩn:</strong> ${item.correctAnswer}
                </li>
            `).join('');
                        quizResultsDiv.innerHTML += `
                <div class="result-correct mt-4">
                    <h5>Các câu trả lời đúng:</h5>
                    <ul>${correctList}</ul>
                </div>
            `;
                    }

                    // Hiển thị danh sách câu sai
                    if (quizResults.incorrect.length > 0) {
                        const incorrectList = quizResults.incorrect.map(item => `
                <li>
                    <strong>Câu hỏi:</strong> ${item.question}<br>
                    ${item.image ? `<img src="${item.image}" alt="Question Image" class="img-fluid mb-2" style="max-width: 200px;">` : ''}
                    <strong>Đáp án của bạn:</strong> ${item.yourAnswer}<br>
                    <strong>Đáp án chuẩn:</strong> ${item.correctAnswer}
                </li>
            `).join('');
                        quizResultsDiv.innerHTML += `
                <div class="result-incorrect mt-4">
                    <h5>Các câu trả lời sai hoặc bỏ qua:</h5>
                    <ul>${incorrectList}</ul>
                </div>
            `;
                    }

                    // Thêm các nút tùy chọn sau khi hoàn thành quiz
                    quizResultsDiv.innerHTML += `
            <div class="mt-4">
                <button class="btn btn-primary mr-2" onclick="restartQuiz()">Làm bài kiểm tra khác</button>
                <button class="btn btn-secondary" onclick="restartStudy()">Học lại từ đầu</button>
            </div>
        `;

                    // Ẩn nút nộp bài
                    document.getElementById('submitQuiz').classList.add('d-none');
                    document.getElementById('skipQuestion').classList.add('d-none');
                }

                // Hàm nộp bài kiểm tra
                function submitQuiz() {
                    if (confirm('Bạn có chắc muốn nộp bài kiểm tra?')) {
                        showQuizResults();
                    }
                }

                // =================== Flashcard Management in Deck Edit Modal ===================
                // Hàm hiển thị danh sách flashcard trong modal chỉnh sửa bộ thẻ
                function populateFlashcardsList(deckIndex) {
                    const container = document.getElementById('flashcardsList');
                    container.innerHTML = '';

                    decks[deckIndex].cards.forEach((card, index) => {
                        const cardDiv = document.createElement('div');
                        cardDiv.className = 'flashcard-item d-flex align-items-start justify-content-between p-2 border rounded mb-2';
                        cardDiv.setAttribute('data-index', index);

                        cardDiv.innerHTML = `
            <div class="d-flex align-items-start" style="min-width: 30px;">
                <span class="me-2">${index + 1}.</span>
                <div class="drag-handle me-2" title="Kéo để di chuyển">☰</div>
            </div>
            <div class="flex-grow-1">
                <strong>Thuật ngữ:</strong> ${card.term}<br>
                <strong>Định nghĩa:</strong> ${card.definition}
                ${card.termImage ? `<br><img src="${card.termImage}" class="img-thumbnail mt-2" style="max-height: 100px;">` : ''}
                ${card.definitionImage ? `<br><img src="${card.definitionImage}" class="img-thumbnail mt-2" style="max-height: 100px;">` : ''}
            </div>
            <div class="ms-2">
                <button class="btn btn-sm btn-primary edit-btn" data-index="${index}">Sửa</button>
                <button class="btn btn-sm btn-danger delete-btn ms-2" data-index="${index}">Xóa</button>
            </div>
        `;

                        container.appendChild(cardDiv);
                    });

                    // Gắn sự kiện chỉnh sửa
                    container.querySelectorAll('.edit-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const idx = parseInt(e.target.getAttribute('data-index'));
                            openEditFlashcardModal(idx);
                        });
                    });

                    // Gắn sự kiện xóa
                    container.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const idx = parseInt(e.target.getAttribute('data-index'));
                            deleteFlashcard(idx);
                        });
                    });
                }

                // Hàm xóa flashcard
                function deleteFlashcard(index) {
                    if (confirm('Bạn có chắc muốn xóa flashcard này không?')) {
                        decks[currentDeck].cards.splice(index, 1);
                        flashcards = decks[currentDeck].cards;
                        populateFlashcardsList(currentDeck);
                        updateFlashcard();
                        updateDecksList();
                        saveData();
                    }
                }


                // =================== Export and Copy Flashcards ===================

                // Hàm lưu dữ liệu vào localStorage
                function saveData() {
                    localStorage.setItem('flashcardData', JSON.stringify({ decks, folders }));
                }

                // Hàm kiểm tra thành tựu (placeholder)
                function checkAchievements() {
                    // Bạn có thể thêm logic để kiểm tra và cấp phát huy hiệu dựa trên các điều kiện
                    // Ví dụ: số lượng bộ thẻ, số lượng flashcard, hoạt động hàng ngày, v.v.
                }

                // =================== Keyboard Navigation ===================




                // Sự kiện khi nhấn phím trên bàn phím
                window.addEventListener('keydown', function (e) {
                    // Chỉ xử lý khi tab "Học" đang hoạt động
                    const studyTab = document.getElementById('study');
                    if (!studyTab.classList.contains('active')) return;

                    switch (e.code) {
                        case 'ArrowLeft':
                            if (currentCard > 0) {
                                goToCard(currentCard - 1, 'prev');
                            }
                            e.preventDefault();
                            break;

                        case 'ArrowRight':
                            if (currentCard < flashcards.length - 1) {
                                goToCard(currentCard + 1, 'next');
                            } else {
                                triggerFireworks();
                                onUserCompletedActivity();

                                showCompletionOptions();
                            }
                            e.preventDefault();
                            break;




                        case 'Space':
                            // Phím cách - lật flashcard
                            document.getElementById('flashcard').classList.toggle('flipped');
                            e.preventDefault();
                            break;
                    }
                });
                // Giả sử flashcards là một mảng các đối tượng, mỗi đối tượng có cấu trúc:
                // { term: "Thuật ngữ", definition: "Định nghĩa" }

                function generateQuizQuestion(flashcards, questionIndex) {
                    // Chọn flashcard làm câu hỏi
                    let correctFlashcard = flashcards[questionIndex];
                    let correctAnswer = correctFlashcard.definition;

                    // Lấy danh sách các flashcard còn lại làm ứng viên cho đáp án sai
                    let candidateDistractors = flashcards.filter((fc, idx) => idx !== questionIndex);

                    // Tính điểm tương đồng giữa đáp án đúng và các ứng viên (sử dụng thư viện string-similarity)
                    let distractorScores = candidateDistractors.map(fc => {
                        let similarity = stringSimilarity.compareTwoStrings(correctAnswer, fc.definition);
                        return { flashcard: fc, similarity: similarity };
                    });

                    // Lọc các ứng viên có mức tương đồng thấp (ví dụ ngưỡng dưới 0.5)
                    let filteredDistractors = distractorScores.filter(item => item.similarity < 0.5);

                    // Sắp xếp theo mức tương đồng từ thấp đến cao (nhiều khác biệt hơn sẽ đứng đầu)
                    filteredDistractors.sort((a, b) => a.similarity - b.similarity);

                    // Chọn ra 4 đáp án sai tốt nhất (nếu có đủ)
                    let distractors = filteredDistractors.slice(0, 4).map(item => item.flashcard.definition);

                    // Nếu chưa đủ 4, bổ sung thêm đáp án sai từ các ứng viên còn lại (xáo trộn trước khi chọn)
                    if (distractors.length < 4) {
                        let remaining = 4 - distractors.length;
                        let additional = candidateDistractors
                            .filter(fc => !distractors.includes(fc.definition))
                            .map(fc => fc.definition);
                        additional = shuffleArray(additional);
                        distractors = distractors.concat(additional.slice(0, remaining));
                    }

                    // Kết hợp đáp án đúng với các đáp án sai
                    let options = distractors.concat([correctAnswer]);

                    // Xáo trộn các đáp án để vị trí của đáp án đúng được ngẫu nhiên
                    options = shuffleArray(options);

                    // Xác định đáp án đúng (theo vị trí sau khi xáo trộn)
                    let correctIndex = options.indexOf(correctAnswer);
                    let optionLetters = ['A', 'B', 'C', 'D', 'E'];
                    let correctOptionLetter = optionLetters[correctIndex];

                    // Trả về cấu trúc câu hỏi cho trắc nghiệm
                    return {
                        question: correctFlashcard.term,
                        options: options.map((option, index) => ({ letter: optionLetters[index], text: option })),
                        correctOption: correctOptionLetter
                    };
                }

                // Hàm hỗ trợ: Xáo trộn một mảng (Fisher-Yates Shuffle)
                function shuffleArray(array) {
                    let currentIndex = array.length, temporaryValue, randomIndex;
                    while (currentIndex !== 0) {
                        randomIndex = Math.floor(Math.random() * currentIndex);
                        currentIndex -= 1;
                        temporaryValue = array[currentIndex];
                        array[currentIndex] = array[randomIndex];
                        array[randomIndex] = temporaryValue;
                    }
                    return array;
                }

                /* 
                Ví dụ sử dụng:
                Giả sử bạn có mảng flashcards như sau:
                let flashcards = [
                  { term: "HTML", definition: "Ngôn ngữ đánh dấu siêu văn bản" },
                  { term: "CSS", definition: "Ngôn ngữ tạo kiểu cho HTML" },
                  { term: "JavaScript", definition: "Ngôn ngữ lập trình cho web" },
                  { term: "PHP", definition: "Ngôn ngữ lập trình phía máy chủ" },
                  { term: "SQL", definition: "Ngôn ngữ truy vấn cơ sở dữ liệu" }
                ];
                
                let quizQuestion = generateQuizQuestion(flashcards, 2);
                console.log(quizQuestion);
                */


                // =================== Fireworks Effect ===================

                // Hàm kích hoạt hiệu ứng pháo hoa
                function triggerFireworks() {
                    const canvas = document.createElement('canvas');
                    canvas.id = 'fireworksCanvas';
                    canvas.style.position = 'fixed';
                    canvas.style.top = 0;
                    canvas.style.left = 0;
                    canvas.style.width = '100vw';
                    canvas.style.height = '100vh';
                    canvas.style.zIndex = 1000;
                    canvas.style.pointerEvents = 'none';
                    document.body.appendChild(canvas);

                    const confetti = window.confetti || null;
                    if (confetti) {
                        // Tạo hiệu ứng pháo hoa
                        confetti.create(canvas, {
                            resize: true,
                            useWorker: true,
                        })({
                            particleCount: 200,
                            spread: 100,
                            origin: { y: 0.6 },
                        });
                    }

                    // Xóa canvas sau 5 giây
                    setTimeout(() => {
                        document.body.removeChild(canvas);
                    }, 5000);
                }

                // Hàm hiển thị các tùy chọn sau khi hoàn thành học
                function showCompletionOptions() {
                    // Hiển thị modal hoàn thành
                    $('#completionModal').modal('show');
                }

                // Hàm khởi động lại quiz
                function restartQuiz() {
                    // Reset các biến liên quan đến quiz
                    currentQuestion = 0;
                    score = 0;
                    quizResults = {
                        correct: [],
                        incorrect: []
                    };
                    startQuiz();
                }

                // Hàm khởi động lại học
                function restartStudy() {
                    // Reset các biến liên quan đến học
                    currentCard = 0;
                    flashcards = decks[currentDeck].cards;
                    updateFlashcard();
                    document.getElementById('flashcard').classList.remove('flipped');
                    $('#study-tab').tab('show');
                }

                // Sự kiện khi nhấn nút "Restart Study" trong modal hoàn thành
                document.getElementById('modalRestartStudyBtn').addEventListener('click', function () {
                    $('#completionModal').modal('hide'); // Đóng modal
                    restartStudy(); // Restart học từ đầu
                });

                // Sự kiện khi nhấn nút "Start Quiz" trong modal hoàn thành
                document.getElementById('modalStartQuizBtn').addEventListener('click', function () {
                    $('#completionModal').modal('hide'); // Đóng modal
                });

                // =================== Theme Toggle ===================

                document.addEventListener('DOMContentLoaded', () => {
                    const themeToggle = document.getElementById('themeToggle');
                    const body = document.body;

                    function toggleTheme() {
                        const isDark = body.classList.toggle('dark-theme');
                        localStorage.setItem('theme', isDark ? 'dark' : 'light');
                        themeToggle.setAttribute('aria-label', `Switch to ${isDark ? 'light' : 'dark'} mode`);
                    }

                    // Lấy trạng thái từ localStorage khi tải trang
                    const savedTheme = localStorage.getItem('theme');
                    if (savedTheme === 'dark') {
                        body.classList.add('dark-theme');
                    }

                    themeToggle.addEventListener('click', toggleTheme);
                });

                // =================== Quiz Toggle Visibility ===================

                document.addEventListener('DOMContentLoaded', function () {
                    const toggleButton = document.getElementById('toggleQuiz');
                    const toggleIcon = document.getElementById('toggleIcon');
                    const quizContent = document.querySelector('.quiz-mode');

                    toggleButton.addEventListener('click', function () {
                        // Chuyển đổi giữa hiển thị và ẩn
                        quizContent.classList.toggle('hidden');

                        // Cập nhật biểu tượng trên nút
                        if (quizContent.classList.contains('hidden')) {
                            toggleIcon.textContent = '+';
                        } else {
                            toggleIcon.textContent = '-';
                        }
                    });
                });

                // =================== Visual Effects ===================

                let effectActive = false; // Trạng thái bật/tắt hiệu ứng
                const toggleEffectButton = document.getElementById('toggleEffect');
                const effectContainer = document.getElementById('effectContainer');
                let interval;

                toggleEffectButton.addEventListener('click', function () {
                    effectActive = !effectActive; // Chuyển trạng thái bật/tắt

                    if (effectActive) {
                        toggleEffectButton.textContent = '📟';
                        startEffect();
                    } else {
                        toggleEffectButton.textContent = '🧩';
                        stopEffect();
                    }
                });

                // Hàm bắt đầu hiệu ứng
                function startEffect() {
                    interval = setInterval(() => {
                        // Tạo ngẫu nhiên một trong bốn loại biểu tượng
                        const symbols = [
                            { className: 'flower', text: '❄️' },
                            { className: 'leaf', text: '🧊' }
                        ];

                        // Lặp qua mỗi biểu tượng để tạo phần tử
                        symbols.forEach(symbol => {
                            const element = document.createElement('div');
                            element.className = symbol.className;
                            element.textContent = symbol.text;

                            // Cài đặt vị trí và hoạt ảnh ngẫu nhiên
                            element.style.left = `${Math.random() * 100}vw`; // Vị trí ngang ngẫu nhiên
                            element.style.animationDuration = `${5 + Math.random() * 3}s`; // Thời gian rơi ngẫu nhiên
                            element.style.fontSize = `${16 + Math.random() * 10}px`; // Kích thước ngẫu nhiên

                            // Thêm phần tử vào container
                            effectContainer.appendChild(element);

                            // Xóa phần tử sau khi hoàn thành animation
                            setTimeout(() => {
                                element.remove();
                            }, 8000); // Thời gian tồn tại trước khi xóa
                        });
                    }, 400); // Tạo hiệu ứng mỗi 400ms
                }

                // Hàm dừng hiệu ứng
                function stopEffect() {
                    clearInterval(interval); // Dừng tạo phần tử mới
                    effectContainer.innerHTML = ''; // Xóa các phần tử hiện có
                }

                // =================== Popup Functionality ===================

                function showPopup(image, title, date, description) {
                    document.getElementById('popup-image').src = image;
                    document.getElementById('popup-title').innerText = title;
                    document.getElementById('popup-date').innerText = date;
                    document.getElementById('popup-description').innerText = description;
                    document.getElementById('popup').classList.add('active');
                    document.getElementById('overlay').classList.add('active');
                }

                function hidePopup() {
                    document.getElementById('popup').classList.remove('active');
                    document.getElementById('overlay').classList.remove('active');
                }
                //hehe
              const STREAK_KEY = 'lofcard_streak';
const LAST_ACTIVE_KEY = 'lofcard_last_active';
const STREAK_RECORDS_KEY = 'lofcard_streakRecords';

function getTodayDateStr() {
    return new Date().toISOString().split('T')[0]; // YYYY-MM-DD
}

function updateStreak() {
    const today = getTodayDateStr();
    const lastActive = localStorage.getItem(LAST_ACTIVE_KEY);
    let streak = parseInt(localStorage.getItem(STREAK_KEY)) || 0;

    if (lastActive === today) {
        // Đã ghi nhận hôm nay
        return streak;
    }

    if (!lastActive) {
        // Lần đầu
        streak = 1;
    } else {
        const lastDate = new Date(lastActive);
        const todayDate = new Date(today);
        const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
            streak += 1;
        } else {
            // 🔥 Nếu không học liên tục → lưu lại streak cũ
            if (streak > 0) {
                const records = JSON.parse(localStorage.getItem(STREAK_RECORDS_KEY)) || [];
                records.push(streak);
                localStorage.setItem(STREAK_RECORDS_KEY, JSON.stringify(records));
            }
            streak = 1; // Reset streak
        }
    }

    localStorage.setItem(STREAK_KEY, streak);
    localStorage.setItem(LAST_ACTIVE_KEY, today);
    return streak;
}

function displayStreak() {
    const count = parseInt(localStorage.getItem(STREAK_KEY)) || 0;
    document.getElementById('streak-count').innerText = count;
}


                // Gọi khi người dùng hoàn thành bài hoặc lật hết bộ thẻ
                function onUserCompletedActivity() {
                    const newStreak = updateStreak();
                    document.getElementById('streak-count').innerText = newStreak;
                }

                // Khởi tạo khi vào trang
                displayStreak();

                function enableSwipeOnFlashcard() {
                    const flashcard = document.getElementById('flashcard');
                    if (!flashcard) return;

                    let touchStartX = 0;
                    let touchEndX = 0;

                    flashcard.addEventListener('touchstart', function (e) {
                        touchStartX = e.changedTouches[0].screenX;
                    }, false);

                    flashcard.addEventListener('touchend', function (e) {
                        touchEndX = e.changedTouches[0].screenX;
                        handleSwipeGesture();
                    }, false);

                    function handleSwipeGesture() {
                        const swipeDistance = touchEndX - touchStartX;
                        const threshold = 50; // Khoảng cách tối thiểu để nhận là vuốt

                        if (swipeDistance > threshold) {
                            // Vuốt sang phải -> chuyển flashcard trước
                            document.getElementById('prevCard').click();
                        } else if (swipeDistance < -threshold) {
                            // Vuốt sang trái -> chuyển flashcard sau
                            document.getElementById('nextCard').click();
                        }
                    }
                }

                // Gọi hàm khi DOM đã load
                document.addEventListener('DOMContentLoaded', enableSwipeOnFlashcard);
                document.getElementById('searchDeckInput').addEventListener('input', function () {
                    const keyword = this.value.toLowerCase();
                    const decks = document.querySelectorAll('#decksList .deck-card');

                    decks.forEach(deck => {
                        const title = deck.querySelector('.card-title')?.textContent.toLowerCase() || '';
                        if (title.includes(keyword)) {
                            deck.style.display = '';
                        } else {
                            deck.style.display = 'none';
                        }
                    });
                });

                // 2. Khi user đổi voice giữa quiz đang chạy
                document.getElementById('quizLanguage')
                    .addEventListener('change', () => {
                        // nếu audio-only đang bật và đang ở giữa quiz, phát lại câu hiện tại
                        if (document.getElementById('audioQuiz').checked) {
                            showQuestion();
                        }
                    });

                // 3. Ẩn/hiện ngay phần audio toggle
                document.getElementById('audioQuiz')
                    .addEventListener('change', () => {
                        // nothing here — chúng ta kiểm tra trực tiếp trong showQuestion()
                    });
                /**
                 * Cập nhật giá trị và giới hạn cho Quiz inputs dựa trên số flashcards hiện tại.
                 */
                function updateQuizDefaults() {
                    const total = flashcards.length;            // số flashcard của bộ đang chọn
                    const qc = document.getElementById('questionCount');
                    const sf = document.getElementById('startFrom');
                    const ea = document.getElementById('endAt');

                    // Nếu chưa có flashcards thì disable luôn
                    if (total === 0) {
                        qc.value = sf.value = ea.value = 0;
                        qc.max = sf.max = ea.max = 0;
                        qc.disabled = sf.disabled = ea.disabled = true;
                        return;
                    }

                    // Bật lại nếu trước đó bị disable
                    qc.disabled = sf.disabled = ea.disabled = false;

                    // Thiết lập giá trị và giới hạn
                    sf.min = 1;
                    sf.max = total;
                    sf.value = 1;

                    ea.min = 1;
                    ea.max = total;
                    ea.value = total;

                    qc.min = 1;
                    qc.max = total;
                    qc.value = total;
                }

                // 2) Khi click “Test Pro”
                // 2) Khi click “Test Pro”
                document.getElementById('testProBtn').addEventListener('click', () => {
                    // ✅ Reset bộ câu hỏi hiện tại
                    currentQuizSet = [];

                    // ✅ Build lại toàn bộ câu hỏi gốc
                    buildQuizQuestions(); // (Hàm này phải tồn tại)

                    // Reset kết quả & UI
                    quizResults = { correct: [], incorrect: [] };
                    score = 0;

                    document.getElementById('quizContent').innerHTML = '';
                    document.getElementById('quizResults').innerHTML = '';

                    const submitBtn = document.getElementById('submitPro');
                    submitBtn.classList.remove('d-none');
                    submitBtn.disabled = false;

                    // ✅ Gọi lại show quiz
                    showProQuiz();
                });

                let currentQuizSet = []; // lưu thứ tự câu hỏi hiện đang hiển thị
             function showProQuiz() {
  const shouldShuffle = document.getElementById('shuffleQuestions')?.checked;

  if (!currentQuizSet.length) {
    currentQuizSet = shouldShuffle ? shuffleArray([...quizQuestions]) : [...quizQuestions];
  }

  const qc = document.getElementById('quizContent');
  qc.innerHTML = currentQuizSet.map((q, idx) => {
    if (typeof q.answered === 'undefined') q.answered = false;

    let pickerHTML = '';

    if (q.isMultipleChoice && q.answers.length > 1) {
      pickerHTML = `
        <form id="multi-${idx}">
          ${q.options.map(opt => `
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox"
                     id="chk-${idx}-${escapeHTML(opt)}"
                     value="${escapeHTML(opt)}">
              <label class="form-check-label" for="chk-${idx}-${escapeHTML(opt)}">
                ${escapeHTML(opt)}
              </label>
            </div>
          `).join('')}
        </form>
      `;
    } else if (q.options && q.options.length > 0) {
      pickerHTML = `
        <div id="opts-${idx}">
          ${q.options.map(opt => `
            <button type="button" class="btn btn-outline-secondary btn-block mb-2 quiz-opt"
                    data-idx="${idx}"
                    data-opt="${escapeHTML(opt)}">
              ${escapeHTML(opt)}
            </button>
          `).join('')}
        </div>
      `;
    } else {
      pickerHTML = `
        <div id="written-${idx}">
          <input type="text" class="form-control written-input mb-2" id="writtenInput-${idx}" placeholder="Nhập câu trả lời">
        </div>
      `;
    }

    // ✅ Format câu hỏi với <br>
    const formattedQuestion = escapeHTML(q.question).replace(/\n/g, '<br>');

    return `
      <div class="card mb-3" id="question-${idx}">
        <div class="card-body">
          <h5 class="card-title">Câu ${idx + 1}/${currentQuizSet.length}</h5>
          <div class="question-text mb-2">${formattedQuestion}</div>
          ${pickerHTML}
        </div>
      </div>
    `;
  }).join('');

  // Gán sự kiện cho từng loại câu hỏi
  currentQuizSet.forEach((q, idx) => {
    // Single answer button
    if (q.options && q.options.length > 0 && (!q.isMultipleChoice || q.answers.length === 1)) {
      document.querySelectorAll(`#opts-${idx} .quiz-opt`).forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll(`#opts-${idx} .quiz-opt`)
            .forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          q.answered = true;
          updateSidebar();
        };
      });
    }

    // Multi-answer (checkboxes)
    if (q.isMultipleChoice && q.answers.length > 1) {
      const checkboxes = document.querySelectorAll(`#multi-${idx} .form-check-input`);
      checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          const checked = Array.from(checkboxes).some(cb => cb.checked);
          q.answered = checked;
          updateSidebar();
        });
      });
    }

    // Written input
    const input = document.getElementById(`writtenInput-${idx}`);
    if (input) {
      input.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const next = document.getElementById(`writtenInput-${idx + 1}`);
          if (next) {
            next.focus();
            next.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      });

      input.addEventListener('input', () => {
        q.answered = input.value.trim().length > 0;
        updateSidebar();
      });
    }
  });

  // Khởi tạo sidebar
  updateSidebar();

  document.getElementById('submitPro').disabled = false;
  document.getElementById('submitPro').onclick = gradeProQuiz;
}



                // 3) Render tất cả câu hỏi mà không chấm ngay
         function gradeProQuiz() {
         onUserCompletedActivity();
  const resultsContainer = document.getElementById('quizResults');
  resultsContainer.innerHTML = '';
  let correctCount = 0;
  const wrong = [];

  currentQuizSet.forEach((q, idx) => {
    const rightSet = new Set(q.answers.map(a => a.trim().toLowerCase()));

    if (q.isMultipleChoice && q.answers.length > 1) {
      const checkboxes = Array.from(document.querySelectorAll(`#multi-${idx} .form-check-input`));
      const checked = checkboxes.filter(cb => cb.checked);
      const userSet = new Set(checked.map(cb => cb.value.trim().toLowerCase()));

      checkboxes.forEach(cb => {
        const val = cb.value.trim().toLowerCase();
        const label = document.querySelector(`label[for="${cb.id}"]`);
        cb.disabled = true;
        if (cb.checked) {
          label.classList.add(rightSet.has(val) ? 'correct' : 'incorrect');
        } else if (rightSet.has(val)) {
          label.classList.add('text-warning', 'fw-bold');
        }
      });

      const allCorrect = userSet.size === rightSet.size && [...rightSet].every(v => userSet.has(v));
      q.answered = true;
      q.isCorrect = allCorrect;

      if (allCorrect) correctCount++;
      else wrong.push(idx + 1);

    } else if (!q.options || q.options.length === 0) {
      const input = document.getElementById(`writtenInput-${idx}`);
      input.disabled = true;

      const userRaw = input.value.trim();
      const normalize = t => t.normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').toLowerCase();
      const userNorm = normalize(userRaw);
      const correctNorms = q.answers.map(a => normalize(a));
      let isCorrect = false;

      if (q.answers.length > 1) {
        const userSet = userRaw.split(',').map(a => normalize(a)).filter(Boolean);
        isCorrect = arraysEqualAsSets(userSet, correctNorms);
      } else {
        const sims = correctNorms.map(ans => calculateSimilarity(userNorm, ans));
        isCorrect = Math.max(...sims) >= 0.8;
      }

      q.answered = true;
      q.isCorrect = isCorrect;

      const fb = document.createElement('div');
      fb.className = 'mt-2';
      input.insertAdjacentElement('afterend', fb);

      if (isCorrect) {
        input.classList.add('correct');
        fb.innerHTML = `<span class="text-success">✅ Chính xác</span>`;
        correctCount++;
      } else {
        input.classList.add('incorrect');
        fb.innerHTML = `<span class="text-danger">❌ Sai. Đúng: ${escapeHTML(q.answers.join(', '))}</span>`;
        wrong.push(idx + 1);
      }

    } else {
      const buttons = Array.from(document.querySelectorAll(`#opts-${idx} .quiz-opt`));
      const selected = buttons.find(b => b.classList.contains('selected'));
      const rightVal = [...rightSet][0];

      let selectedVal = null;

      buttons.forEach(btn => {
        const val = btn.dataset.opt.trim().toLowerCase();
        btn.disabled = true;

        if (selected) {
          selectedVal = selected.dataset.opt.trim().toLowerCase();
          if (val === selectedVal) {
            btn.classList.add(val === rightVal ? 'correct' : 'incorrect');
          } else if (val === rightVal && selectedVal !== rightVal) {
            btn.classList.add('correct');
          }
        } else {
          if (val === rightVal) btn.classList.add('text-warning', 'fw-bold');
        }
      });

      q.answered = !!selected;
      const isCorrect = selected && selectedVal === rightVal;
      q.isCorrect = isCorrect;
      if (isCorrect) correctCount++;
      else wrong.push(idx + 1);
    }
  });

  resultsContainer.innerHTML = `
    <div class="alert alert-info">Đúng ${correctCount}/${currentQuizSet.length}</div>
    <div class="alert alert-danger">
      Sai: ${
        wrong.length
          ? wrong.map(i => `<a href="#" class="wrong-link" data-q-idx="${i - 1}">${i}</a>`).join(', ')
          : 'Không có'
      }
    </div>
  `;

  if (wrong.length) {
    const wrongQuestions = wrong.map(i => currentQuizSet[i - 1]);
    const redoBtn = document.createElement('button');
    redoBtn.className = 'btn btn-warning mt-2';
    redoBtn.textContent = '🔁 Làm lại câu sai';
    redoBtn.onclick = () => buildQuizWithWrongQuestions(wrongQuestions);
    resultsContainer.appendChild(redoBtn);
  }

  document.querySelectorAll('.wrong-link').forEach(el => {
    el.onclick = e => {
      e.preventDefault();
      const i = parseInt(el.dataset.qIdx);
      const elTarget = document.getElementById(`question-${i}`);
      if (elTarget) elTarget.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };
  });
  const percentage = Math.round((correctCount / currentQuizSet.length) * 100);

 if (percentage === 100) {
                        triggerFireworks();
                    }
  updateSidebar();
  document.getElementById('submitPro').disabled = true;
}


                function buildQuizWithWrongQuestions(wrongQuestions) {
                    currentQuizSet = [...wrongQuestions];
                    document.getElementById('quizContent').innerHTML = '';
                    document.getElementById('quizResults').innerHTML = '';
                    const submitBtn = document.getElementById('submitPro');
                    submitBtn.classList.remove('d-none');
                    submitBtn.disabled = false;
                    showProQuiz();
                }

                function redoWrongQuestions(wrongArray) {
                    wrongArray.forEach(i => {
                        const q = currentQuizSet[i];

                        // Tự luận
                        if (!q.options || q.options.length === 0) {
                            const input = document.getElementById(`writtenInput-${i}`);
                            if (input) {
                                input.disabled = false;
                                input.readOnly = false;
                                input.value = '';
                                input.classList.remove('correct', 'incorrect');
                                const fb = input.nextElementSibling;
                                if (fb && fb.classList.contains('mt-2')) fb.remove();
                            }
                        }

                        // Nhiều đáp án
                        if (q.isMultipleChoice && q.answers.length > 1) {
                            const checkboxes = document.querySelectorAll(`#multi-${i} .form-check-input`);
                            checkboxes.forEach(cb => {
                                cb.checked = false;
                                cb.disabled = false;
                                const label = document.querySelector(`label[for="${cb.id}"]`);
                                label.classList.remove('correct', 'incorrect', 'text-warning', 'fw-bold');
                            });
                        }

                        // Một đáp án
                        if (q.options && q.options.length > 0 && (!q.isMultipleChoice || q.answers.length === 1)) {
                            const buttons = document.querySelectorAll(`#opts-${i} .quiz-opt`);
                            buttons.forEach(btn => {
                                btn.classList.remove('correct', 'incorrect', 'selected', 'text-warning', 'fw-bold');
                                btn.disabled = false;
                            });
                        }
                    });

                    // Cho phép nộp lại
                    const submitBtn = document.getElementById('submitPro');
                    submitBtn.disabled = false;

                    // Cuộn đến câu sai đầu tiên
                    const first = document.getElementById(`question-${wrongArray[0]}`);
                    if (first) {
                        first.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }

                    // Xoá kết quả
                    document.getElementById('quizResults').innerHTML = '';
                }
function updateSidebar() {
  const sidebar = document.getElementById('quizSidebar');
  sidebar.innerHTML = '';

  currentQuizSet.forEach((q, idx) => {
    let iconClass = 'bi-circle';         // ⬜️ chưa làm
    let extraClass = 'fw-bold text-secondary'; // in đậm

    if (q.answered && q.isCorrect === true) {
      iconClass = 'bi-check-circle-fill';      // ✅ đúng
      extraClass = 'text-success';
    } else if (q.answered && q.isCorrect === false) {
      iconClass = 'bi-x-circle-fill';          // ❌ sai
      extraClass = 'text-danger';
    } else if (q.answered) {
      iconClass = 'bi-pencil-fill';            // 🟦 đã làm (chưa chấm)
      extraClass = 'text-primary';
    }

    const div = document.createElement('div');
  div.className = `q-link ${extraClass} d-flex align-items-center mb-1 fw-bold`;

    div.style.cursor = 'pointer';
    div.innerHTML = `<i class="bi ${iconClass} me-2"></i>${idx + 1}`;
    div.onclick = () => {
      const el = document.getElementById(`question-${idx}`);
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };
    sidebar.appendChild(div);
  });
}

function renderStreakDashboard() {
  const STREAK_KEY = 'lofcard_streak';
  const RECORDS_KEY = 'lofcard_streakRecords';
  const toastContainer = document.getElementById("streak-toast-container");

  let records = JSON.parse(localStorage.getItem(RECORDS_KEY)) || [];
  const currentStreak = parseInt(localStorage.getItem(STREAK_KEY)) || 0;

  const combined = [...records];
  if (currentStreak > 0) {
    combined.push(currentStreak);
  }

  const sorted = [...combined].sort((a, b) => b - a);
  const tbody = document.querySelector("#streakTable tbody");
  tbody.innerHTML = '';

  // Toast chúc mừng nếu lọt top 3
  if (sorted.slice(0, 3).includes(currentStreak) && currentStreak > 0) {
    showToast(`🎉 Bạn đã lọt vào TOP 3 với ${currentStreak} ngày streak!`);
  }

  // Render từng dòng bảng
  sorted.forEach((s, i) => {
    const type = i === 0 ? '🥇 Top 1' : i === 1 ? '🥈 Top 2' : i === 2 ? '🥉 Top 3' : 'Thường';
    const row = document.createElement("tr");

    // Highlight top rows
    if (i === 0) row.classList.add("table-warning");
    else if (i === 1) row.classList.add("table-secondary");
    else if (i === 2) row.classList.add("table-info");

    row.innerHTML = `
      <td>#${i + 1}</td>
      <td>${s} ngày 🔥</td>
      <td>${type}</td>
    `;
    tbody.appendChild(row);
  });
}

// Toast popup mừng
function showToast(message) {
  const toast = document.createElement("div");
  toast.className = "toast-msg";
  toast.innerText = message;
  document.getElementById("streak-toast-container").appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}

// Gọi khi vào tab
document.getElementById("achievements-tab")?.addEventListener("click", renderStreakDashboard);
if (document.getElementById("achievements")?.classList.contains("active")) {
  renderStreakDashboard();
}
// =================== Export to JSON ===================
document.getElementById('exportJsonBtn').addEventListener('click', function () {
    const deckName = document.getElementById('editDeckName').value.trim();
    if (!deckName || !decks[deckName]) {
        alert('Không tìm thấy bộ thẻ để xuất.');
        return;
    }

    const deck = decks[deckName];
    const jsonData = JSON.stringify(deck.cards, null, 2); // xuất danh sách thẻ

    const blob = new Blob([jsonData], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `${deckName}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
});

            </script>

</body>

</html>